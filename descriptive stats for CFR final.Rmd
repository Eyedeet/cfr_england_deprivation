---
title: "descriptive stats for LA and ONS data"
author: "Anne Marie Suffel"
date: "26 6 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(rgdal)
library(broom)
require(maps)
library(sp)
library(magrittr)
library(tidycomm)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(patchwork)
library(flextable)
##uploading theLA_code
load(file = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Final data sets/ons_data.Rdata")
```




```{r, echo = FALSE}
# Data preparation step 1:
# defining different agegroups according to literature for being more at risk
# - people above 50
# - people abobe 60
# - people above 65
# - peple above 70

colnames(ons_data)
#---renaming the dataset and bringing variables into the right format
ons_data$code <- factor(ons_data$code)
ons_data$name <- factor(ons_data$name)
ons_data$Region <- factor(ons_data$Region)
ons_data$week <- as.integer(ons_data$week)
ons_data$imd_5s <- as.factor(ons_data$imd_5s)
ons_data$imd_10s <- as.factor(ons_data$imd_10s)
ons_data$imd_5r <- as.factor(ons_data$imd_5r)
ons_data$imd_10r <- as.factor(ons_data$imd_10r)
ons_data$imd_5_most_dep <- as.factor(ons_data$imd_5_most_dep)
ons_data$imd_10_most_dep <- as.factor(ons_data$imd_10_most_dep)
ons_data$imd_5_most_depr <- as.factor(ons_data$imd_5_most_depr)
ons_data$imd_10_most_depr <- as.factor(ons_data$imd_10_most_depr)
ons_data$prop_most_deprived <- as.numeric(ons_data$prop_most_deprived)


ons_data <- ons_data %>%
  dplyr::mutate(month = lubridate::month(date))
ons_data$month <- factor(ons_data$month, labels = c("January", "February", "March", "April", "May", "June"))


ons_data <- ons_data %>%
              dplyr::rename(all_ages = pop_tot, females = fem_tot, males = mal_tot)

ons_temp <- ons_data %>%
              dplyr::select(c(code, all_ages, age_0, age_2, age_3, age_4, age_5, age_6, age_7, age_8, age_9, age_10, age_11, age_12, age_13,
                              age_14, age_15, age_16, age_17, age_18, age_19, age_20, age_21, age_22, age_23, age_24, age_25,
                              age_26, age_27, age_28, age_29, age_30, age_31, age_32, age_33, age_34, age_35, age_36, age_37, age_38, 
                              age_39, age_40, age_41, age_42, age_43, age_44, age_45, age_46, age_47, age_48, age_49, age_50, age_51,
                              age_52, age_53, age_54, age_55, age_56, age_57, age_58, age_59, age_60, age_61, age_62, age_63, age_64,
                              age_65, age_66, age_67, age_68, age_69, age_70, age_71, age_72, age_73, age_74, age_75, age_76, age_77, 
                              age_78, age_79, age_80, age_81, age_82, age_83, age_84, age_85, age_86, age_87, age_88, age_89, age_90,
                              males, females)) %>%
              dplyr::distinct()

#---calculating the number of persons within different agebands being more or less at risk of covid
ons_temp <- ons_temp %>%
                  dplyr::group_by(code) %>%
                  dplyr::mutate(pop_under_19 = sum(age_0, age_2, age_3, age_4, age_5, age_6, age_7, age_8, age_9, age_10, age_11, age_12, 
                                              age_13, age_14, age_15,  age_16, age_17, age_18),
                                pop_under_50 = sum(age_0, age_2, age_3, age_4, age_5, age_6, age_7, age_8, age_9, age_10, age_11, age_12, 
                                              age_13, age_14, age_15,  age_16, age_17, age_18, age_19, age_20, age_21, age_22, age_23, age_24,
                                              age_25, age_26, age_27, age_28, age_29, age_30, age_31, age_32, age_33, age_34, age_35, age_36,
                                              age_37, age_38, age_39, age_40, age_41, age_42, age_43, age_44, age_45, age_46, age_47, age_48, 
                                            age_49),
                                pop_over_50 = sum(age_50, age_51, age_52, age_53, age_54, age_55, age_56, age_57, age_58,age_59, age_60, age_61,
                                                  age_62, age_63, age_64, age_65, age_66, age_67, age_68, age_69, age_70, age_71, age_72, age_73,
                                                  age_74, age_75, age_76, age_77, age_78, age_79,age_80, age_81, age_82, age_83, age_84, age_85, age_86,
                                                  age_87, age_88, age_89, age_90), 
                                pop_over_60 = sum(age_60, age_61, age_62, age_63, age_64, age_65, age_66, age_67, age_68, age_69, age_70, age_71, age_72,
                                                  age_73,age_74, age_75, age_76, age_77, age_78, age_79,age_80, age_81, age_82, age_83, age_84, age_85, 
                                                  age_86,age_87, age_88, age_89, age_90),
                                pop_over_65 = sum(age_65, age_66, age_67, age_68, age_69, age_70, age_71, age_72, age_73,age_74, age_75, age_76, age_77,
                                                  age_78, age_79,age_80, age_81, age_82, age_83, age_84, age_85,age_86,age_87, age_88, age_89, age_90),
                                pop_over_70 = sum(age_70, age_71, age_72, age_73,age_74, age_75, age_76, age_77,age_78, age_79,age_80, age_81, age_82, 
                                                  age_83, age_84, age_85,age_86,age_87, age_88, age_89, age_90)) 


#---calculating the percentages of different age groups and gender
ons_temp <- ons_temp %>%
              dplyr::select(c(code, all_ages, pop_under_19, pop_under_50, pop_over_50, pop_over_60, pop_over_65, pop_over_70, females, males))
                            
ons_temp <- ons_temp %>%
          dplyr::mutate(male_per = ((males * 100)/all_ages), female_per = ((females * 100)/all_ages), pop_under_19_per = ((pop_under_19 * 100)/all_ages),
                        pop_under_50_per = ((pop_under_50 * 100/all_ages)), pop_over_60_per = ((pop_over_60 * 100)/all_ages),
                        pop_over_50_per = ((pop_over_50 * 100)/all_ages), pop_over_65_per = ((pop_over_65 * 100)/all_ages), 
                        pop_over_70_per = ((pop_over_70 * 100)/all_ages))


#--- joining the datasets
ons_temp <- ons_temp %>%
              dplyr::select(c(code, pop_under_19, pop_under_19_per, pop_under_50, pop_under_50_per, pop_over_50, pop_over_50_per, 
                              pop_over_65, pop_over_65_per, pop_over_70, pop_over_70_per, male_per, female_per))
ons_data <- ons_data %>%
              dplyr::left_join(ons_temp, by = "code") %>%
              dplyr:: distinct()

remove(ons_temp)
head(ons_data)


```



Calculating the propoertion of BAME population per LA
````{r, echo = FASLE}
colnames(ons_data)
ons_temp <- ons_data %>%
              dplyr::select(c(code, White_British, Other_White, Mixed, Asian, Black, Other, all_ages)) %>%
              dplyr::distinct()
#--- calculating the size of white and BAME population
ons_temp <- ons_temp %>%
                  dplyr::group_by(code) %>%
                  dplyr::mutate(white = sum(White_British, Other_White), BAME = sum(Mixed, Asian, Black, Other, na.rm = TRUE))


#---calcaulating the percentage of the minority BAme population per LA
ons_temp <- ons_temp %>%
          dplyr::mutate(BAME_per = (BAME * 100)/all_ages)

head(ons_temp)

#--- joining the datasets
ons_temp <- ons_temp %>%
              dplyr::select(c(code, white, BAME, BAME_per))
ons_data <- ons_data %>%
              dplyr::left_join(ons_temp, by = "code") %>%
              dplyr:: distinct()
head(ons_data)

````

Calculating the total number of deaths and cases per setting 
Calculating the other deaths which are not covid-related

````{r, echo = FALSE}

##--- Calculating the total number of deaths and cases per setting 
#--- Calculating the other deaths which are not covid-related
ons_data<- ons_data %>%
                dplyr::group_by(code) %>%
                dplyr::mutate(total_covid_cases = sum(lab.cases, na.rm = TRUE),
                              total_covid_deaths = sum(covid.deaths.home, covid.deaths.hospital, covid.deaths.care.home, covid.deaths.hospice,
                                                       covid.deaths.communal.establishement, covid.deaths.elsewhere, na.rm = TRUE),
                              total_covid_deaths_home = sum(covid.deaths.home, na.rm = TRUE),
                              total_covid_deaths_hospital = sum(covid.deaths.hospital, na.rm = TRUE),
                              total_covid_deaths_hospice = sum(covid.deaths.hospice, na.rm = TRUE),
                              total_covid_deaths_communal_establishement =  sum(covid.deaths.communal.establishement, na.rm = TRUE),
                              total_covid_deaths_carehome = sum(covid.deaths.care.home, na.rm = TRUE),
                              total_covid_deaths_elsewhere = sum(covid.deaths.elsewhere, na.rm = TRUE))
ons_data<- ons_data %>%
                dplyr::group_by(code) %>%
                dplyr::mutate(covid_cases_ratio = (total_covid_cases*100000)/all_ages,
                              covid_deaths_ratio = (total_covid_deaths*100000)/all_ages,
                             covid_deaths_home_ratio = (total_covid_deaths_home*100000)/all_ages,
                             covid_deaths_hospital_ratio = (total_covid_deaths_hospital*100000)/all_ages,
                             covid_deaths_hospice_ratio = (total_covid_deaths_hospice*100000)/all_ages,
                             covid_deaths_communal_establishement_ratio =  (total_covid_deaths_communal_establishement*100000)/all_ages,
                             covid_deaths_elsewhere_ratio = (total_covid_deaths_elsewhere*100000)/all_ages,
                             covid_deaths_carehome_ratio = (total_covid_deaths_carehome*100000)/all_ages)

#---weekly number of other deaths during the time of the CFR calculations
temp <- ons_data %>%
  dplyr::select(code, week, 
                covid.deaths.home, covid.deaths.hospital, covid.deaths.care.home, covid.deaths.hospice, covid.deaths.communal.establishement, 
                covid.deaths.elsewhere, lab.cases) %>%
  dplyr::distinct()


temp <- temp %>%
   dplyr::filter(week >= 10 & week <=22) %>%
  dplyr::group_by(code, week) %>%
  dplyr::mutate(weekly_cases = sum(lab.cases, na.rm = TRUE)) %>%
  dplyr::select(-(lab.cases)) %>%
  dplyr::distinct() %>%
  dplyr::mutate(weekly_deaths = sum(covid.deaths.home, covid.deaths.hospital, covid.deaths.care.home, covid.deaths.hospice,
                                                       covid.deaths.communal.establishement,covid.deaths.elsewhere, na.rm = TRUE),
                prop_carehomes = covid.deaths.care.home/weekly_deaths)


temp <- temp %>%
  dplyr::select(-c(covid.deaths.home, covid.deaths.hospital, covid.deaths.care.home, covid.deaths.hospice,
                                                       covid.deaths.communal.establishement,covid.deaths.elsewhere))
ons_data <- ons_data %>%
  dplyr::left_join(temp, by = c("code", "week"))

colnames(ons_data)


#---weekly number of other deaths during the time of the CFR calculations
temp <- ons_data %>%
  dplyr::select(code, week, 
                covid.deaths.home, covid.deaths.hospital, covid.deaths.care.home, covid.deaths.hospice, covid.deaths.communal.establishement, 
                covid.deaths.elsewhere,
                all.deaths.home, all.deaths.hospital, all.deaths.care.home,all.deaths.hospice, all.deaths.communal.establishement , all.deaths.care.home,
               all.deaths.elsewhere, all_ages) %>%
  dplyr::distinct()

temp <- temp %>%
   dplyr::filter(week >= 10 & week <=22) %>%
                dplyr::group_by(code, week) %>%
                dplyr::mutate(other_deaths = (sum(all.deaths.home, all.deaths.hospital, all.deaths.care.home, all.deaths.hospice,
                                                       all.deaths.communal.establishement, all.deaths.elsewhere, na.rm = TRUE))-
                                (sum(covid.deaths.home, covid.deaths.hospital, covid.deaths.care.home, covid.deaths.hospice,
                                                       covid.deaths.communal.establishement, covid.deaths.elsewhere, na.rm = TRUE)),
                              other_deaths_home = all.deaths.home-covid.deaths.home,
                              other_deaths_hospital = all.deaths.hospital-covid.deaths.hospital,
                              other_deaths_hospice = all.deaths.hospice-covid.deaths.hospice,
                              other_deaths_communal_establishement = all.deaths.communal.establishement-covid.deaths.communal.establishement,
                              other_deaths_carehome = all.deaths.care.home-covid.deaths.care.home,
                              other_deaths_elsewhere = all.deaths.elsewhere-covid.deaths.elsewhere)

temp <- temp %>%
  dplyr::select(-c(all_ages,  covid.deaths.home, covid.deaths.hospital, covid.deaths.care.home, covid.deaths.hospice, covid.deaths.communal.establishement,
                covid.deaths.elsewhere,
                all.deaths.home, all.deaths.hospital, all.deaths.care.home,all.deaths.hospice, all.deaths.communal.establishement , all.deaths.care.home,
               all.deaths.elsewhere))


ons_data <- ons_data %>%
  dplyr::left_join(temp, by = c("code", "week"))



````

Filtering the massive dataset to reduce a little bit the size of vectors used

```{r , echo= FALSE}
#Filtering the massive dataset to reduce a little bit the size of vectors used
ons <- ons_data %>%
        dplyr::select( c(code, name, all_ages, date, lab.cases, week, month,  Region, median_age, pop_density,
                        covid.deaths.home, covid.deaths.hospital,  covid.deaths.care.home,  covid.deaths.hospice, covid.deaths.communal.establishement,
                        covid.deaths.elsewhere,
                        weekly_deaths, weekly_cases, prop_carehomes, 
                        other_deaths, other_deaths_home,other_deaths_hospital,other_deaths_hospice, other_deaths_communal_establishement, 
                        other_deaths_carehome, other_deaths_elsewhere,
                        prop_most_deprived, imd_5_most_dep, imd_5s, imd_5r,
                       female_per, BAME_per,
                       obs_ratio, diab_ratio, hyper_ratio, pop_under_19, pop_under_19_per, pop_under_50,
                        pop_under_50_per, pop_over_50, pop_over_50_per, pop_over_65, pop_over_65_per, pop_over_70, pop_over_70_per,
                        total_covid_cases, total_covid_deaths, total_covid_deaths_home, total_covid_deaths_hospital, total_covid_deaths_hospice,
                        total_covid_deaths_communal_establishement,total_covid_deaths_elsewhere, total_covid_deaths_carehome, 
                        covid_cases_ratio, covid_deaths_ratio, covid_deaths_carehome_ratio, covid_deaths_home_ratio, covid_deaths_hospital_ratio,
                         covid_deaths_hospice_ratio, covid_deaths_communal_establishement_ratio, covid_deaths_elsewhere_ratio,
                         ))

ons$Region <- factor(ons$Region, labels = c("East", "East total", "East Midlands", "East Midlands total", "London", "London total", "North East", "Nort West", "Nort West total", "South East", "South East total", "South West", "South West total", "West Midlands",
                                            "West Midlands total"))

#give nicer names to everything
ons <- ons %>%
  dplyr::rename(weekly_deaths_hospital = covid.deaths.hospital, 
                weekly_deaths_home = covid.deaths.home,
                weekly_deaths_carehome = covid.deaths.care.home,
                weekly_deaths_hospice = covid.deaths.hospice,
                weekly_deaths_communal_establishement = covid.deaths.communal.establishement,
                weekly_deaths_elsewhere = covid.deaths.elsewhere)


#---calculate the weekly mortality per 100,000 inhabitants

ons <- ons %>%
  dplyr::group_by(week, code) %>%
  dplyr::mutate(weekly_mortality = (weekly_deaths*100000)/all_ages,
                weekly_mortality_hospital = (weekly_deaths_hospital*100000)/all_ages,
                weekly_mortality_home = (weekly_deaths_home*100000)/all_ages,
                weekly_mortality_carehome = (weekly_deaths_carehome*100000)/all_ages,
                weekly_mortality_hospice = (weekly_deaths_hospice*100000)/all_ages, 
                weekly_mortality_communal_establishement = (weekly_deaths_communal_establishement*100000)/all_ages,
                weekly_mortality_elsewhere = (weekly_deaths_elsewhere*100000)/all_ages,
                weekly_mortality_other = (other_deaths*1000000)/all_ages,
                weekly_mortality_hospital_other = (other_deaths_hospital*100000)/all_ages,
                weekly_mortality_home_other = (other_deaths_home*100000)/all_ages,
                weekly_mortality_carehome_other = (other_deaths_carehome*100000)/all_ages,
                weekly_mortality_hospice_other = (other_deaths_hospice*100000)/all_ages, 
                weekly_mortality_communal_establishement_other = (other_deaths_communal_establishement*100000)/all_ages,
                weekly_mortality_elsewhere_other = (other_deaths_elsewhere*100000)/all_ages)


#---monthly mortality
temp <- ons %>%
  dplyr::select(month, week, code,weekly_deaths,weekly_cases,  weekly_deaths_hospital, weekly_deaths_home, weekly_deaths_carehome, 
                weekly_deaths_hospice, weekly_deaths_communal_establishement, weekly_deaths_elsewhere,
                other_deaths, other_deaths_hospital, other_deaths_home, other_deaths_carehome, other_deaths_hospice,
                other_deaths_communal_establishement, other_deaths_elsewhere, prop_carehomes,
                all_ages) %>%
  dplyr::distinct() %>%
  dplyr::group_by(month, code) %>%
  dplyr::mutate(monthly_mortality = (sum(weekly_deaths, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_hospital = (sum(weekly_deaths_hospital, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_home = (sum(weekly_deaths_home, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_carehome = (sum(weekly_deaths_carehome, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_hospice = (sum(weekly_deaths_hospice, na.rm = TRUE)*100000)/all_ages, 
                monthly_mortality_communal_establishement = (sum(weekly_deaths_communal_establishement, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_elsewhere = (sum(weekly_deaths_elsewhere, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_other = (sum(other_deaths, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_hospital_other = (sum(other_deaths_hospital, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_home_other = (sum(other_deaths_home, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_carehome_other = (sum(other_deaths_carehome, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_hospice_other = (sum(other_deaths_hospice, na.rm = TRUE)*1000000)/all_ages, 
                monthly_mortality_communal_establishement_other = (sum(other_deaths_communal_establishement, na.rm = TRUE)*100000)/all_ages,
                monthly_mortality_elsewhere_other = (sum(other_deaths_elsewhere, na.rm = TRUE)*100000)/all_ages,
                monthly_cases = sum(weekly_cases, na.rm = TRUE), 
                monthly_prop_carehomes = mean(prop_carehomes, na.rm = TRUE))


#---joining the data sets
temp <- temp %>%
  dplyr::select(month,code, 
                monthly_mortality, monthly_mortality_hospital, monthly_mortality_home, monthly_mortality_carehome,  monthly_mortality_hospice,
                monthly_mortality_communal_establishement,monthly_mortality_elsewhere,
                monthly_mortality_other, monthly_mortality_hospital_other, monthly_mortality_home_other, monthly_mortality_hospice_other,
                monthly_mortality_carehome_other, monthly_mortality_communal_establishement_other,monthly_mortality_elsewhere_other,
                monthly_cases, monthly_prop_carehomes )

ons <- ons %>%
  dplyr::left_join(temp, by = c("month", "code"))

```


Calculating CFR according to the best time interval adjusting for reporting delays between cases and deaths and different settings 
CFRs, step 1: optimising the time delay between cases and deaths among all places to die
````{r, echo = FALSE}
df1 <- ons %>%
  dplyr::select(week, code, weekly_cases) %>%
  dplyr::distinct() %>%
  dplyr::mutate(week = as.numeric(week)) %>%
  dplyr::rename(week_test = week)

df2 <- ons %>%
  dplyr::select(week, code, weekly_deaths) %>%
  dplyr::distinct() %>%
  dplyr::mutate(week = as.numeric(week),
                week_1 =  week-1, 
                week_2 = week-2,
                week_3 = week- 3)

head(df2)

#---no reporting dealy at all
df_join <- df2 %>%
  dplyr::rename(week_test = week)
test <- df1 %>%
  dplyr::left_join(df_join, by = c("code", "week_test")) %>%
  dplyr::filter(week_test >= 9 & week_test <=21) %>%
  dplyr::filter(complete.cases(weekly_deaths, weekly_cases)) %>%
  dplyr::arrange(week_test) %>%
  dplyr::group_by(week_test) %>%
  dplyr::mutate(total_weekly_cases = sum(weekly_cases),
                   total_weekly_deaths = sum(weekly_deaths))
test <- test %>%
  dplyr::select(week_test, total_weekly_cases, total_weekly_deaths) %>%
  dplyr::distinct() %>%
  dplyr::filter(complete.cases(total_weekly_cases, total_weekly_deaths))

# #---correlation
# cor.test(test$total_weekly_cases, test$total_weekly_deaths,  alternative = "two.sided", use = "pairwise", method = "pearson",
#             adjust = "holm", alpha = 0.05, ci = TRUE, minlength = 5)
 #---correlation coefficient:  0.876645

#---reporting delay one week
df_join <- df2 %>%
  dplyr::rename(week_test = week_1)
test1 <- df1 %>%
  dplyr::left_join(df_join, by = c("code", "week_test")) %>%
  dplyr::filter(week_test >= 9 & week_test <=21) %>%
  dplyr::filter(complete.cases(weekly_deaths, weekly_cases)) %>%
  dplyr::arrange(week_test) %>%
  dplyr::group_by(week_test) %>%
  dplyr::mutate(total_weekly_cases = sum(weekly_cases),
                   total_weekly_deaths = sum(weekly_deaths))
test1 <- test1 %>%
  dplyr::select(week_test, total_weekly_cases, total_weekly_deaths) %>%
  dplyr::distinct() %>%
  dplyr::filter(complete.cases(total_weekly_cases, total_weekly_deaths))


# #---correlation
#  cor.test(test1$total_weekly_cases, test1$total_weekly_deaths,  alternative = "two.sided", use = "pairwise", method = "pearson",
#             adjust = "holm", alpha = 0.05, ci = TRUE, minlength = 5)
# #---correlation coefficient: 0.9967728  

 #---reporting delay 2 weeks
df_join <- df2 %>%
  dplyr::rename(week_test = week_2)
test2 <- df1 %>%
  dplyr::left_join(df_join, by = c("code", "week_test")) %>%
  dplyr::filter(week_test >= 9 & week_test <=21) %>%
  dplyr::filter(complete.cases(weekly_deaths, weekly_cases)) %>%
  dplyr::arrange(week_test) %>%
  dplyr::group_by(week_test) %>%
  dplyr::mutate(total_weekly_cases = sum(weekly_cases),
                   total_weekly_deaths = sum(weekly_deaths))
test2 <- test2 %>%
  dplyr::select(week_test, total_weekly_cases, total_weekly_deaths) %>%
  dplyr::distinct() %>%
  dplyr::filter(complete.cases(total_weekly_cases, total_weekly_deaths))
# #---correlation
#  cor.test(test2$total_weekly_cases, test2$total_weekly_deaths,  alternative = "two.sided", use = "pairwise", method = "pearson",
#             adjust = "holm", alpha = 0.05, ci = TRUE, minlength = 5)
# #---correlation coefficient is 0.8245597 
 
  #---reporting delay 3 weeks
df_join <- df2 %>%
  dplyr::rename(week_test = week_3)
test3 <- df1 %>%
  dplyr::left_join(df_join, by = c("code", "week_test")) %>%
  dplyr::filter(week_test >= 9 & week_test <=21) %>%
  dplyr::filter(complete.cases(weekly_deaths, weekly_cases)) %>%
  dplyr::arrange(week_test) %>%
  dplyr::group_by(week_test) %>%
  dplyr::mutate(total_weekly_cases = sum(weekly_cases),
                   total_weekly_deaths = sum(weekly_deaths))
test3 <- test3 %>%
  dplyr::select(week_test, total_weekly_cases, total_weekly_deaths) %>%
  dplyr::distinct() %>%
  dplyr::filter(complete.cases(total_weekly_cases, total_weekly_deaths))
# #---correlation
#  cor.test(test3$total_weekly_cases, test3$total_weekly_deaths,  alternative = "two.sided", use = "pairwise", method = "pearson",
#             adjust = "holm", alpha = 0.05, ci = TRUE, minlength = 5)
# #---correlation coefficient is 0.3588141
````





Step three, calculating the the actual CFR with the best time delay of reporting
home: no delay
all places and hospitals: one week delay
hospices and care homes: two weeks delay

```{r, echo = FALSE}

cfr <- function(cases, deaths) {

  if(is.na(cases) | is.na(deaths)){
    return(NA)
  }
  if(is.na(cases) & is.na(deaths)){
    return(NA)
  }
  if(deaths == 0){
    result <- 0
  }
  if(cases == 0){
    result <- 0
  }
  else{
    result <- (deaths/cases)*100
  }
  
  return(result)
}

#---adjusting for different reporting delays in the different places of death 
#--- dying in all places and in hospitals with 1 week delay
#--- dying at home with no reporting delay
#--- dying in hospices and care homes with 2 weeks reporting delay

df <- ons %>%
  dplyr::select(code, week, month,  weekly_cases,  weekly_deaths) %>%
  dplyr::distinct() %>%
  dplyr::mutate(week = as.numeric(week))

df1 <- df %>%
  dplyr::select(week, code, weekly_deaths) %>%
  dplyr::mutate(week = week-1) %>%
  dplyr::rename(weekly_deaths_adj = weekly_deaths)
df<- df %>%
  dplyr::left_join(df1, by = c("week", "code"))

#---staying in the time range when pandemic really started and deaths ans cases are still reported for the weeks
df <- df %>%
  dplyr::distinct() %>%
  dplyr::filter(week >= 9 & week <=21)
#--account for the case of massive reporting bias that there are more deaths than cases and set the number of cases to the number of deaths
correct_impossible <- function(df) {
  
correct <- which(df$weekly_deaths_adj > df$weekly_cases)
for(i in 1:length(correct)){
  pos <- correct[i]
  df$weekly_cases[pos] <- df$weekly_deaths_adj[pos]
}
return(df)}

df <- correct_impossible(df)
# test whether it has worked
which(df$weekly_deaths_adj > df$weekly_cases)
summary(df$weekly_deaths_adj)
summary(df$weekly_cases)
#--- calculating the CFR per week
df <- df %>%
  dplyr::mutate(weekly_cfr_overall = cfr(cases = weekly_cases, deaths = weekly_deaths_adj)) #79NAs
summary(df$weekly_cfr_overall)

#-adjusting for underreporting
load(file = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Final data sets/cfr_estimates.Rdata")

df <- df %>%
  dplyr::left_join(cfr_estimates, by = "week")
df <- df %>%
  dplyr::mutate(weekly_cfr_overall_adj = weekly_cfr_overall*weekly_cfr,
                weekly_cfr_overall_adj_lb = weekly_cfr_overall*weekly_cfr_lower,
                weekly_cfr_overall_adj_ub = weekly_cfr_overall*weekly_cfr_upper)
#---calculation of the monthly CFR
df <- df %>%
  dplyr::group_by(code, month) %>%
  dplyr::mutate(mcfr_overall_adj = mean(weekly_cfr_overall_adj, na.rm= TRUE),
                mcfr_overall_adj_lb = mean(weekly_cfr_overall_adj_lb, na.arm = TRUE),
                mcfr_overall_adj_ub = mean(weekly_cfr_overall_adj_ub, na.rm = TRUE))


#---final joining of the data sets
ons <- ons %>%
   dplyr::left_join(df, by = c("code", "week", "month")) %>%
  dplyr::distinct() %>%
  dplyr::select(-c(weekly_cases.y, weekly_deaths.y)) %>%
  dplyr::rename(weekly_cases = weekly_cases.x, 
                weekly_deaths = weekly_deaths.x)


#--- calculate the weekly cases corrected for undderreporting
ons <- ons %>%
  dplyr::mutate(weekly_cases_corrected = weekly_cases/weekly_cfr)

ons$weekly_cases_corrected <- round(ons$weekly_cases_corrected, digits = 0)
summary(ons$weekly_cases_corrected)
summary(ons$weekly_cases)
summary(ons$mcfr_overall_adj)


````


````{r, echo h= FALSE}
#---summarising the different LAs by IMD values, quintiles of IMD rank

df <- ons %>%
  dplyr::select(code, week, month, weekly_cfr_overall_adj, weekly_cfr_overall_adj_lb,  weekly_cfr_overall_adj_ub,
             imd_5s) %>%
  dplyr::distinct()



#---summarising the different LAs by IMD values, quintiles of IMD score of the most deprived

df1 <- df %>%
  dplyr::group_by(week, imd_5s) %>%
  dplyr::summarise(cfr_by_imd_5_most_dep = mean(weekly_cfr_overall_adj, na.rm= TRUE),
                 cfr_by_imd_5_most_dep_lb = mean(weekly_cfr_overall_adj_lb, na.rm= TRUE),
                  cfr_by_imd_5_most_dep_ub = mean(weekly_cfr_overall_adj_ub, na.rm= TRUE)) %>%
  filter(week >= 9 & week <=21)

#--- storing the results in the original data frame
df1 <- df1 %>%
  dplyr::select(week, imd_5s, cfr_by_imd_5_most_dep, cfr_by_imd_5_most_dep_lb,cfr_by_imd_5_most_dep_ub )
ons <- ons %>%
  dplyr::left_join(df1, by = c("imd_5s", "week"))

#--monthly CFR per IMD
df2 <- ons %>%
  dplyr::select(code,  month,  week,  
             mcfr_overall_adj,mcfr_overall_adj_lb,  mcfr_overall_adj_ub, imd_5s) %>%
  dplyr::distinct() %>%
  dplyr::filter(week >= 9 & week <=21)
 
df2 <- na.omit(df2) %>%
    dplyr::ungroup()%>%
  dplyr::select(month, imd_5s, mcfr_overall_adj, mcfr_overall_adj_lb,  mcfr_overall_adj_ub) %>%
  dplyr::group_by(month, imd_5s) %>%
  dplyr::summarise(mcfr_by_imd_5_most_dep = mean(mcfr_overall_adj, na.rm= TRUE),
                 mcfr_by_imd_5_most_dep_lb = mean(mcfr_overall_adj_lb, na.rm= TRUE),
                  mcfr_by_imd_5_most_dep_ub = mean(mcfr_overall_adj_ub, na.rm= TRUE))

df2 <- df2 %>%
  dplyr::select(month, imd_5s, mcfr_by_imd_5_most_dep , mcfr_by_imd_5_most_dep_lb,mcfr_by_imd_5_most_dep_ub )
ons <- ons %>%
  dplyr::left_join(df2, by = c("imd_5s", "month"))

#---just monthly CFR
df3 <- ons %>%
  dplyr::select(code,  month,  week,  
             mcfr_overall_adj,mcfr_overall_adj_lb,  mcfr_overall_adj_ub) %>%
  dplyr::distinct() %>%
  dplyr::filter(week >= 9 & week <=21)
df3 <- na.omit(df3) %>%
  dplyr::ungroup()%>%
  dplyr::select(month,  mcfr_overall_adj, mcfr_overall_adj_lb,  mcfr_overall_adj_ub) %>%
  dplyr::filter(month == "March" |month == "April" | month == "May") %>%
  dplyr::group_by(month) %>%
  dplyr::summarise(mcfr = mean(mcfr_overall_adj, na.rm= TRUE),
                 mcfr_lb = mean(mcfr_overall_adj_lb, na.rm= TRUE),
                  mcfr_ub = mean(mcfr_overall_adj_ub, na.rm= TRUE))
df3 <- df3 %>%
  dplyr::select(month ,mcfr , mcfr_lb ,mcfr_ub )
ons <- ons %>%
  dplyr::left_join(df3, by = c("month"))


````

Summarising the CFRs by using different imd_scores

````{r, include = TRUE, echo = FALSE}
#--colour palettes for the graphs
# color blind friendly palette (with grey):
col_vibrant <- c("#0077BB",   "#33BBEE",  "#009988",  "#EE7733",
                 "#CC3311",  "#EE3377",  "#BBBBBB")
col_muted <- c(  "#332288",  "#88CCEE",  "#44AA99",  "#117733",
                   "#999933",  "#DDCC77",  "#CC6677",  "#882255", 
                 "#AA4499",  "#BBBBBB")
cbf_1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73", 
           "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# color_blind_friendly palette (with black): 
cbf_2 <- c("#000000", "#E69F00", "#56B4E9", "#009E73", 
           "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

  #---plotting the results of the CFRs
overall_weekly_cfr_plot <- ons %>%
  dplyr::filter(!(is.na(imd_5s))) %>%
  dplyr::filter(week >= 5 & week <= 22) %>%
  ggplot2::ggplot(aes(x = week, y = cfr_by_imd_5_most_dep, group = imd_5_most_dep, fill = imd_5_most_dep, colour = imd_5s)) + 
  ggplot2::geom_line(size = 1) + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
 ggplot2::scale_color_manual(values = col_vibrant[6:1])+
  ggplot2::ggtitle("Case-Fatality-Fatio by deprivation index of the Local Authority") + 
  ggplot2:: ylab("adjusted CFR in %")+
  ggplot2:: xlab("Week in 2020")+
  ggplot2::geom_errorbar(aes(ymin=cfr_by_imd_5_most_dep_lb,ymax=cfr_by_imd_5_most_dep_ub),width = 0.2, size = 0.5)+
  ggplot2::labs(colour = "IMD quintile")+
  theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))+
  guides(fill = FALSE)
  

overall_monthly_cfr_plot <- ons %>%
  dplyr::filter(!is.na(imd_5_most_dep)) %>%
  ggplot2::ggplot(aes(x = month, y = mcfr_by_imd_5_most_dep, group = imd_5s, fill = imd_5s, colour = imd_5s)) + 
  ggplot2::geom_line(size=1) + 
  ggplot2::ggtitle("Case-Fatality-Fatio per deprivation \n of the Local Authority") + 
  ggplot2:: ylab("adjusted CFR in %")+
  ggplot2:: xlab("Month in 2020")+
  scale_x_discrete(limits = c("March", "April", "May"))+
  ggplot2::geom_errorbar(aes(ymin=mcfr_by_imd_5_most_dep_lb,ymax=mcfr_by_imd_5_most_dep_ub),width = 0.2, size = 0.5)+
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
 ggplot2::scale_color_manual(values = col_vibrant[6:1])+
  ggplot2::labs(color = "IMD quintile") +
    theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size=12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))+
  guides(fill = FALSE)




ggsave(filename = "overall_weekly_cfr_plot.jpeg", plot = overall_weekly_cfr_plot, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot")


ggsave(filename = "overall_monthly_cfr_plot.jpeg", plot = overall_monthly_cfr_plot, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot")  


overall_weekly_cfr_plot
overall_monthly_cfr_plot

````







Graphs for cases and deaths per week/month for all the LAs
````{r, echo = FALSE}
#--- bar graph  for cases and deaths across all local authorities
colnames(ons)


# Here we define spaces as the big separator
point <- scales::format_format(big.mark = ",", decimal.mark = ".", scientific = FALSE)
dat <- ons %>%
  dplyr::select(code, week, weekly_deaths, weekly_cases, weekly_deaths_hospital, weekly_deaths_home, weekly_deaths_carehome) %>%
  distinct() %>%
  dplyr::group_by(week) %>%
  dplyr::summarise(weekly_deaths_sum =  sum(weekly_deaths, na.rm= TRUE), 
                   weekly_cases_sum = sum(weekly_cases, na.rm = TRUE),
                   weekly_deaths_hospital_sum = sum(weekly_deaths_hospital, na.rm = TRUE),
                   weekly_deaths_home_sum = sum(weekly_deaths_home, na.rm = TRUE),
                   weekly_deaths_carehome_sum = sum(weekly_deaths_carehome, na.rm = TRUE))
 

#overall cases 
weekly_cases_graph <- ggplot(data = dat, aes(x = week, y =weekly_cases_sum)) +
  ggplot2::geom_bar(stat = "identity", colour = "#009E73", fill = "#009E73") + 
  ggplot2::ylab("total number of cases") +
  ggplot2::xlab("week in  2020") +
  scale_y_continuous(labels = point)+
  ggplot2::ggtitle("Total number of cases across all Local Authorities in England")+
      theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"))



#---bar graph of weekly deaths
weekly_deaths_graph <- ggplot(data = dat, aes(x = week, y = weekly_deaths_sum )) +
  ggplot2::geom_bar(stat = "identity",, colour = "#009E73", fill = "#009E73") + 
  ggplot2::ylab("total number of deaths") +
  ggplot2::xlab("week in 2020") +
  scale_y_continuous(labels = point, limits = c(0, 8000))+
  ggplot2::ggtitle("Total number of deaths across all Local Authorities in England")+
      theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"))



ggsave(filename = "weekly_cases_graph.jpeg", plot = weekly_cases_graph, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)

ggsave(filename = "weekly_deaths_graph.jpeg", plot = weekly_deaths_graph, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)


````

Bar graphs for deaths and cases
````{r, include = FALSE}
#--- bar graph  for cases and deaths across all local authorities per month
#---formulaa for exact poisson, has be be divided by time at risk
exactPoiCI_lb<- function (rate, conf.level=0.95) {
  n = (length(rate)-sum(is.na(rate)))
  X = n*mean(rate, na.rm = TRUE)
  alpha = 1 - conf.level
  lower <- (0.5 * qchisq(alpha/2, (2*mean(X) +2)))/n
  return(lower)
}

exactPoiCI_ub <- function (rate, conf.level=0.95) {
  n = (length(rate)-sum(is.na(rate)))
  X = n*mean(rate, na.rm = TRUE)
  alpha = 1 - conf.level
  upper <- (0.5 * qchisq((1-(alpha/2)), (2*mean(X) +2)))/n
  return(upper)
}



# Here we define spaces as the big separator
point <- scales::format_format(big.mark = ",", decimal.mark = ".", scientific = FALSE)

````

````{r, echo = FALSE}
dat <- ons %>%
  dplyr::select(code, week,  month, monthly_mortality, monthly_mortality_hospital, monthly_mortality_home, monthly_mortality_carehome) %>%
  distinct() %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(week)) %>%
  distinct() %>%
  dplyr::filter(month == "March"| month == "April" | month == "May") %>%
  dplyr::group_by(month) %>%
  dplyr::mutate(monthly_mortality_mean =  mean(monthly_mortality, na.rm= TRUE), 
                   monthly_mortality_lb = exactPoiCI_lb(rate = monthly_mortality),
                   monthly_mortality_ub = exactPoiCI(rate = monthly_mortality),
                monthly_mortality_hospital_mean =  mean(monthly_mortality_hospital, na.rm= TRUE), 
                   monthly_mortality_hospital_lb = exactPoiCI_lb(monthly_mortality_hospital),
                   monthly_mortality_hospital_ub = exactPoiCI(monthly_mortality_hospital),
                monthly_mortality_carehome_mean =  mean(monthly_mortality_carehome, na.rm= TRUE), 
                   monthly_mortality_carehome_lb = exactPoiCI_lb(monthly_mortality_carehome),
                   monthly_mortality_carehome_ub = exactPoiCI(monthly_mortality_carehome),
                monthly_mortality_home_mean =  mean(monthly_mortality_home, na.rm= TRUE), 
                   monthly_mortality_home_lb = exactPoiCI_lb(monthly_mortality_home),
                   monthly_mortality_home_ub = exactPoiCI(monthly_mortality_home))
 



plot_overall_mortality <- 
  ggplot2::ggplot(dat, aes(x = month, y = monthly_mortality_mean))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge(), colour = "#009E73", fill = "#009E73")+
  ggplot2::labs(title = "Average monthly mortality from COVID-19 in every LA",
                x = "Month in 2020",
                y = "mortality rate per 100,000") + 
  scale_y_continuous(labels = point, limits = c(0, 75))+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_lb , ymax = monthly_mortality_ub), width=0.5,
                  size=1) +
      theme(plot.title = element_text(hjust = 0.5, size = 20, face = "bold"),
        axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"))


plot_hospital_mortality <- 
  ggplot2::ggplot(dat, aes(x = month, y = monthly_mortality_hospital_mean))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge(), colour = "#009E73", fill = "#009E73")+
  ggplot2::labs(title = "Average monthly mortality from COVID-19\n in hospitals in every LA",
                x = "Month in 2020",
                y = "mortality rate per 100,000") + 
  scale_y_continuous(labels = point, limits = c(0, 75))+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_hospital_lb , ymax = monthly_mortality_hospital_ub), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 26, face = "bold"),
        axis.text=element_text(size=20),
        axis.title=element_text(size=22,face="bold"))

plot_home_mortality <- 
  ggplot2::ggplot(dat, aes(x = month, y = monthly_mortality_home_mean))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge(), colour = "#009E73", fill = "#009E73")+
  ggplot2::labs(title = "Average monthly mortality from COVID-19\n at home in every LA",
                x = "Month in 2020",
                y = "mortality rate per 100,000") + 
  scale_y_continuous(labels = point, limits = c(0, 75))+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_home_lb , ymax = monthly_mortality_home_ub), width=0.5,
                  size=1) +
      theme(plot.title = element_text(hjust = 0.5, size = 26, face = "bold"),
        axis.text=element_text(size=20),
        axis.title=element_text(size=22,face="bold"))


plot_carehome_mortality <- 
  ggplot2::ggplot(dat, aes(x = month, y = monthly_mortality_carehome_mean))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge(), colour = "#009E73", fill = "#009E73")+
  ggplot2::labs(title = "Average monthly mortality from COVID-19\n in care homes in every LA",
                x = "Month in 2020",
                y = "mortality rate per 100,000") + 
  scale_y_continuous(labels = point, limits = c(0, 75))+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_carehome_lb , ymax = monthly_mortality_carehome_ub), width=0.5,
                  size=1) +
      theme(plot.title = element_text(hjust = 0.5, size = 26, face = "bold"),
        axis.text=element_text(size=20),
        axis.title=element_text(size=22,face="bold"))


 all_LA_CFR <- ons %>%
   ggplot(aes(x = month, y = mcfr)) + 
   geom_line(group = 1, show.legend = FALSE, size = 1,   colour = "#009E73") + 
   ggtitle("Averaged monthly case-fatality-ratio across all local authorities in England") + 
   ylab("adjusted CFR in %")+
   ggplot2:: xlab("month in 2020")+
   ggplot2::scale_x_discrete(limits = c("March", "April", "May"))+
   geom_errorbar(aes(ymin=mcfr_lb,ymax=mcfr_ub), width = 0.2, size = 0.5)+
     theme(plot.title = element_text(hjust = 0.5, size = 22, face = "bold"),
         legend.title = element_blank(),
         legend.text = element_blank(),
         legend.position = "none", 
         axis.text=element_text(size=16),
         axis.title=element_text(size=18,face="bold"))+
       guides(fill = FALSE,
              colour = FALSE)


 
ggsave(filename = "plot_overall_mortality.jpeg", plot = plot_overall_mortality, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
ggsave(filename = "plot_hospital_mortality.jpeg", plot = plot_hospital_mortality, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
ggsave(filename = "plot_home_mortality.jpeg", plot = plot_home_mortality, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
ggsave(filename = "plot_carehome_mortality.jpeg", plot = plot_carehome_mortality, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
ggsave(filename = "all_LA_CFR.jpeg", plot = all_LA_CFR, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
all_LA_CFR

````

Mortaliy by deprivation and month

````{r, echo = FALSE}
colnames(ons)
dat <- dat <- ons %>%
  dplyr::select(code, week,  month, imd_5s,  monthly_mortality, monthly_mortality_hospital, monthly_mortality_home, monthly_mortality_carehome) %>%
  distinct() %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(week)) %>%
  distinct() %>%
  dplyr::filter(month == "March") %>%
  dplyr::group_by(imd_5s) %>%
  dplyr::mutate(monthly_mortality_mean =  mean(monthly_mortality, na.rm= TRUE), 
                   monthly_mortality_lb = exactPoiCI_lb(monthly_mortality),
                   monthly_mortality_ub = exactPoiCI_ub(monthly_mortality),
                monthly_mortality_hospital_mean =  mean(monthly_mortality_hospital, na.rm= TRUE), 
                   monthly_mortality_hospital_lb = exactPoiCI_lb(monthly_mortality_hospital),
                   monthly_mortality_hospital_ub = exactPoiCI_ub(monthly_mortality_hospital),
                monthly_mortality_carehome_mean =  mean(monthly_mortality_carehome, na.rm= TRUE), 
                   monthly_mortality_carehome_lb = exactPoiCI_lb(monthly_mortality_carehome),
                   monthly_mortality_carehome_ub = exactPoiCI_ub(monthly_mortality_carehome),
                monthly_mortality_home_mean =  mean(monthly_mortality_home, na.rm= TRUE), 
                   monthly_mortality_home_lb = exactPoiCI_lb(monthly_mortality_home),
                   monthly_mortality_home_ub = exactPoiCI_ub(monthly_mortality_home))

mort_all_march <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality per quintile of deprivation in March 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
 ggplot2::scale_color_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_lb, ymax = monthly_mortality_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")

mort_all_march

mort_hospital_march <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_hospital_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality in hospitals per quintile of deprivation in March 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_hospital_lb, ymax = monthly_mortality_hospital_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")


mort_home_march <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_home_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality at home per quintile of deprivation in March 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_home_lb, ymax = monthly_mortality_home_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")

mort_carehome_march <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_carehome_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality in care homes per quintile of deprivation in March 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_carehome_lb, ymax = monthly_mortality_carehome_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")


dat <- dat <- ons %>%
  dplyr::select(code, week,  month, imd_5s,  monthly_mortality, monthly_mortality_hospital, monthly_mortality_home, monthly_mortality_carehome) %>%
  distinct() %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(week)) %>%
  distinct() %>%
  dplyr::filter(month == "April") %>%
  dplyr::group_by(imd_5s) %>%
  dplyr::mutate(monthly_mortality_mean =  mean(monthly_mortality, na.rm= TRUE), 
                   monthly_mortality_lb = exactPoiCI_lb(monthly_mortality),
                   monthly_mortality_ub = exactPoiCI_ub(monthly_mortality),
                monthly_mortality_hospital_mean =  mean(monthly_mortality_hospital, na.rm= TRUE), 
                   monthly_mortality_hospital_lb = exactPoiCI_lb(monthly_mortality_hospital),
                   monthly_mortality_hospital_ub = exactPoiCI_ub(monthly_mortality_hospital),
                monthly_mortality_carehome_mean =  mean(monthly_mortality_carehome, na.rm= TRUE), 
                   monthly_mortality_carehome_lb = exactPoiCI_lb(monthly_mortality_carehome),
                   monthly_mortality_carehome_ub = exactPoiCI_ub(monthly_mortality_carehome),
                monthly_mortality_home_mean =  mean(monthly_mortality_home, na.rm= TRUE), 
                   monthly_mortality_home_lb = exactPoiCI_lb(monthly_mortality_home),
                   monthly_mortality_home_ub = exactPoiCI_ub(monthly_mortality_home))

mort_all_april <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality per quintile of deprivation in April 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_lb, ymax = monthly_mortality_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")


mort_hospital_april <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_hospital_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality in hospitals per quintile of deprivation in April 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_hospital_lb, ymax = monthly_mortality_hospital_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")

mort_home_april <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_home_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality at home per quintile of deprivation in April 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_home_lb, ymax = monthly_mortality_home_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")

mort_carehome_april <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_carehome_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality in care homes per quintile of deprivation in April 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_carehome_lb, ymax = monthly_mortality_carehome_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")




mort_all_april
mort_hospital_april
mort_home_april
mort_carehome_april



dat <- dat <- ons %>%
  dplyr::select(code, week,  month, imd_5s,  monthly_mortality, monthly_mortality_hospital, monthly_mortality_home, monthly_mortality_carehome) %>%
  distinct() %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(week)) %>%
  distinct() %>%
  dplyr::filter(month == "May") %>%
  dplyr::group_by(imd_5s) %>%
  dplyr::mutate(monthly_mortality_mean =  mean(monthly_mortality, na.rm= TRUE), 
                   monthly_mortality_lb = exactPoiCI_lb(monthly_mortality),
                   monthly_mortality_ub = exactPoiCI_ub(monthly_mortality),
                monthly_mortality_hospital_mean =  mean(monthly_mortality_hospital, na.rm= TRUE), 
                   monthly_mortality_hospital_lb = exactPoiCI_lb(monthly_mortality_hospital),
                   monthly_mortality_hospital_ub = exactPoiCI_ub(monthly_mortality_hospital),
                monthly_mortality_carehome_mean =  mean(monthly_mortality_carehome, na.rm= TRUE), 
                   monthly_mortality_carehome_lb = exactPoiCI_lb(monthly_mortality_carehome),
                   monthly_mortality_carehome_ub = exactPoiCI_ub(monthly_mortality_carehome),
                monthly_mortality_home_mean =  mean(monthly_mortality_home, na.rm= TRUE), 
                   monthly_mortality_home_lb = exactPoiCI_lb(monthly_mortality_home),
                   monthly_mortality_home_ub = exactPoiCI_ub(monthly_mortality_home))

mort_all_may <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality per quintile of deprivation in May 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_lb, ymax = monthly_mortality_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")


mort_hospital_may <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_hospital_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality in hospitals per quintile of deprivation in May 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_hospital_lb, ymax = monthly_mortality_hospital_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")

mort_home_may <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_home_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality at home per quintile of deprivation in May 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_home_lb, ymax = monthly_mortality_home_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),

        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")

mort_carehome_may <- 
  ggplot2::ggplot(dat, aes(x = imd_5s, y = monthly_mortality_carehome_mean, fill = imd_5s))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality in care homes per quintile of deprivation in May 2020",
                x = "quintile of index of multiple deprivation",
                y = "mortality rate per 100,000") + 
  ggplot2::scale_fill_manual(values = col_vibrant[6:1])+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_carehome_lb, ymax = monthly_mortality_carehome_ub ), width=0.5,
                  size=1)+
      theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
                legend.title = element_blank(),
        legend.text = element_blank(), 
        legend.position = "none")


mort_carehome_may

ggsave(filename = "mort_all_march.jpeg", plot = mort_all_march, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
ggsave(filename = "mort_hospital_march.jpeg", plot = mort_hospital_march, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
ggsave(filename = "mort_home_march.jpeg", plot = mort_home_march, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
ggsave(filename = "mort_carehome_march.jpeg", plot = mort_carehome_march, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)


ggsave(filename = "mort_all_april.jpeg", plot = mort_all_april, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)

ggsave(filename = "mort_hospital_april.jpeg", plot = mort_hospital_april, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)

ggsave(filename = "mort_home_april.jpeg", plot = mort_home_april, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)

ggsave(filename = "mort_carehome_april.jpeg", plot = mort_carehome_april, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)


ggsave(filename = "mort_all_may.jpeg", plot = mort_all_may, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)

ggsave(filename = "mort_hospital_may.jpeg", plot = mort_hospital_may, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)
ggsave(filename = "mort_home_may.jpeg", plot = mort_home_may, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)

ggsave(filename = "mort_carehome_may.jpeg", plot = mort_carehome_may, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot",  
       width = 297, height = 210, units = c("mm"),dpi = 300, limitsize = TRUE)


````


Exploring and plotting cases per LA

````{r, echo = FALSE}
#---mortality per Regoin
dat <- dat <- ons %>%
  dplyr::select(code, week, Region,  month, monthly_mortality) %>%
  distinct() %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(week)) %>%
  distinct() %>%
  dplyr::filter(month == "March") %>%
  dplyr::group_by(Region) %>%
  dplyr::summarise(monthly_mortality_mean =  mean(monthly_mortality, na.rm= TRUE), 
                   monthly_mortality_lb = exactPoiCI_lb(monthly_mortality),
                   monthly_mortality_ub = exactPoiCI(monthly_mortality))


mort_Region_march <- 
  ggplot2::ggplot(dat, aes(x = Region, y = monthly_mortality_mean, fill = Region))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality per Region in March 2020",
                                  fill = "Region",
                x = "Region",
                y = "mortality rate per 100,000") + 
  scale_y_continuous(labels = point, limits = c(0, 80))+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_lb, ymax = monthly_mortality_ub ), width=0.5,
                  size=0.2)

dat <- ons %>%
  dplyr::select(code, week, Region,  month, monthly_mortality) %>%
  distinct() %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(week)) %>%
  distinct() %>%
  dplyr::filter(month == "April") %>%
  dplyr::group_by(Region) %>%
  dplyr::summarise(monthly_mortality_mean =  mean(monthly_mortality, na.rm= TRUE), 
                   monthly_mortality_lb = exactPoiCI_lb(monthly_mortality),
                   monthly_mortality_ub = exactPoiCI(monthly_mortality))



mort_Region_april <- 
  ggplot2::ggplot(dat, aes(x = Region, y = monthly_mortality_mean, fill = Region))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality per Region in April 2020",
                                  fill = "Region",
                x = "Region",
                y = "mortality rate per 100,000") + 
  scale_y_continuous(labels = point, limits = c(0, 80))+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_lb, ymax = monthly_mortality_ub ), width=0.5,
                  size=0.2)

dat <- ons %>%
  dplyr::select(code, week, Region,  month, monthly_mortality) %>%
  distinct() %>%
  dplyr::ungroup() %>%
  dplyr::select(-c(week)) %>%
  distinct() %>%
  dplyr::filter(month == "May") %>%
  dplyr::group_by(Region) %>%
  dplyr::summarise(monthly_mortality_mean =  mean(monthly_mortality, na.rm= TRUE), 
                   monthly_mortality_lb = exactPoiCI_lb(monthly_mortality),
                   monthly_mortality_ub = exactPoiCI(monthly_mortality))


mort_Region_may <- 
  ggplot2::ggplot(dat, aes(x = Region, y = monthly_mortality_mean, fill = Region))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Average mortality per Region in May 2020",
                                  fill = "Region",
                x = "Region",
                y = "mortality rate per 100,000") + 
   scale_y_continuous(labels = point, limits = c(0, 80))+
  ggplot2::geom_errorbar(aes(ymin = monthly_mortality_lb, ymax = monthly_mortality_ub ), width=0.5,
                  size=0.2)



ggsave(filename = "mort_Region_march.jpeg", plot = mort_Region_march, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot", 
        width = 297, height = 210, units = c("mm"), dpi = 300, limitsize = TRUE)

ggsave(filename = "mort_Region_april.jpeg", plot = mort_Region_april, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot", 
        width = 297, height = 210, units = c("mm"), dpi = 300, limitsize = TRUE)

ggsave(filename = "mort_Region_may.jpeg", plot = mort_Region_may, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Results/plot", 
        width = 297, height = 210, units = c("mm"), dpi = 300, limitsize = TRUE)



`````


Descriptive summaries of explanatory variables
````{r, echo = FALSE}

des_stats <- function(vec) {
  n = length(vec)-sum(is.na(vec))
  mean = mean(vec, na.rm = TRUE)
  sd = sd(vec, na.rm = TRUE)
  min = min(vec, na.rm = TRUE)
  median = median(vec, na.rm = TRUE)
  max = max(vec, na.rm = TRUE)
  
  result <- c(n, mean, sd, min, median, max)
  return(result)
}


 sum <- ons %>%
  dplyr::ungroup()%>%
  dplyr::select(code, pop_over_65_per, female_per, BAME_per, diab_ratio, obs_ratio, hyper_ratio, pop_density,
                prop_most_deprived, Region, monthly_prop_carehomes) %>%
  dplyr::distinct()


age <- des_stats(sum$pop_over_65_per)
gender <- des_stats(sum$female_per)
ethnic <- des_stats(sum$BAME_per)
diab <- des_stats(sum$diab_ratio)
obs <- des_stats(sum$obs_ratio)
hyper <- des_stats(sum$hyper_ratio)
pop <- des_stats(sum$pop_density)
dep <- des_stats(sum$prop_most_deprived)
#reg <- des_stats(sum$Region)

table <- data.frame(age, gender, ethnic, diab,  obs, hyper, pop, dep)
table <-data.frame(t(table))
table <- table %>%
  dplyr::mutate(n = round(X1, digits = 2),
               mean = round(X2, digits = 2),
              sd = round(X3, digits = 2),
                min = round(X4, digits = 2),
                median = round(X5, digits = 2),
              max = round(X6, digits = 2)) %>%
  dplyr::select(-c(X1, X2, X3, X4, X5, X6))


flextable(table)


table

sd(sum$prop_most_deprived*100, na.rm= TRUE)
summary(sum$Region)

test <- ons %>%
  dplyr::ungroup() %>%
  dplyr::select(code, all_ages) %>%
  dplyr::distinct()

des_stats(test$all_ages)

des_stats(sum$monthly_prop_carehomes)

````


Descriptive sumamry of all dependent variables
````{r, include = FALSE}

colnames(ons)
 sum <- ons %>%
  dplyr::ungroup()%>%
  dplyr::select(code, total_covid_cases, total_covid_deaths) %>%
  dplyr::distinct()


cases <- des_stats(sum$total_covid_cases)
deaths <- des_stats(sum$total_covid_deaths)

#reg <- des_stats(sum$Region)

table <- data.frame(cases, deaths)
table <-data.frame(t(table))
table <- table %>%
  dplyr::mutate(n = round(X1, digits = 2),
               mean = round(X2, digits = 2),
              sd = round(X3, digits = 2),
                min = round(X4, digits = 2),
                median = round(X5, digits = 2),
              max = round(X6, digits = 2)) %>%
  dplyr::select(-c(X1, X2, X3, X4, X5, X6))


flextable(table)
table



 sum <- ons %>%
  dplyr::ungroup()%>%
  dplyr::filter(month =="March" | month == "April" | month== "May") %>%
  dplyr::select(code, month, monthly_mortality, monthly_mortality_hospital, monthly_mortality_home, monthly_mortality_carehome, 
                mcfr_overall_adj) %>%
   distinct()

mort <- des_stats(sum$monthly_mortality)
mort_hosp <- des_stats(sum$monthly_mortality_hospital)
mort_home <- des_stats(sum$monthly_mortality_home)
mort_carehome <- des_stats(sum$monthly_mortality_carehome)
cfr <- des_stats(sum$mcfr_overall_adj)

table <- data.frame(mort, mort_hosp, mort_home, mort_carehome, cfr)
table <-data.frame(t(table))
table <- table %>%
  dplyr::mutate(n = round(X1, digits = 2),
               mean = round(X2, digits = 2),
              sd = round(X3, digits = 2),
                min = round(X4, digits = 2),
                median = round(X5, digits = 2),
              max = round(X6, digits = 2)) %>%
  dplyr::select(-c(X1, X2, X3, X4, X5, X6))


flextable(table)
table
 
````

BIVARIATE ANALYSES

Kruskal Walli test for month and IMD
````{r, inlcude = FALSE}
temp <- ons %>%
  dplyr::ungroup() %>%
  dplyr::select(code, month, mcfr_overall_adj, mcfr_overall_adj_lb, mcfr_overall_adj_ub, 
                monthly_prop_carehomes, 
                pop_over_65_per, imd_5s,  Region, pop_density, diab_ratio, obs_ratio, hyper_ratio, BAME_per, female_per) %>%
  dplyr::distinct() 

temp$imd_5s <- ordered(temp$imd_5s, levels = c(1, 2, 3, 4, 5))
temp$month <- ordered(temp$month, levels = c("March", "April", "May"))


#tests for deprivation
unianova(imd_5s, mcfr_overall_adj, data = temp)

temp %>%
kruskal.test(imd_5s ~monthly_mortality_home, data = temp)
#temp %>%
#kruskal.test(imd_5s ~monthly_mortality_carehome, data = temp)

#tests for Region
unianova(Region, mcfr_overall_adj, data = temp)

#temp %>%
#kruskal.test(Region ~monthly_mortality_home, data = temp)
#temp %>%
#kruskal.test(Region ~monthly_mortality_carehome, data = temp)

#tests for month
unianova(month, mcfr_overall_adj, data = temp)


```

OTHER BIVARIATES of continnuous varibales
````{r, include = FALSE}

#CFR
cor.test(temp$pop_over_65_per, temp$mcfr_overall_adj, method= "spearman")
cor.test(temp$female_per, temp$mcfr_overall_adj, method= "spearman")
cor.test(temp$pop_density, temp$mcfr_overall_adj, method= "spearman")
cor.test(temp$BAME_per, temp$mcfr_overall_adj, method= "spearman")
cor.test(temp$diab_ratio, temp$mcfr_overall_adj, method= "spearman")
cor.test(temp$obs_ratio, temp$mcfr_overall_adj, method= "spearman")
cor.test(temp$hyper_ratio, temp$mcfr_overall_adj, method= "spearman")
cor.test(temp$monthly_prop_carehomes, temp$mcfr_overall_adj, method="spearman" )

````





One WAY ANOVA for Regions
````{r, inlcude = FALSE}

temp <- ons %>%
  dplyr::ungroup() %>%
  dplyr::select(code, month, monthly_mortality, monthly_mortality_hospital, monthly_mortality_home, monthly_mortality_carehome,
                mcfr_overall_adj,
                Region, imd_5s, imd_5_most_dep) %>%
  dplyr::distinct() 

march <- temp %>%
  dplyr::filter(month=="March")%>%
  distinct()

april <- temp %>%
  dplyr::filter(month == "April") %>%
  distinct()

may <- temp %>%
  dplyr::filter(month=="May") %>%
  distinct()

march %>%
unianova(imd_5s, monthly_mortality,monthly_mortality_hospital,monthly_mortality_home, monthly_mortality_carehome, mcfr_overall_adj)
march %>%
unianova(Region, monthly_mortality,monthly_mortality_hospital,monthly_mortality_home, monthly_mortality_carehome, mcfr_overall_adj)

```



Function to calculate the CI and SE of the mean for big dataset
````{r, echo FALSE}
#---function to calutae my confidence intervals for the results table

SE <- function(x) {
  error <- qnorm(0.975) * sd(x, na.rm = T)/sqrt(length(x)-sum(is.na(x)))
  return(error)
}

ci_lower <- function(x) {
  lower <- mean(x, na.rm=T) - (qnorm(0.975) * sd(x, na.rm = T)/sqrt(length(x)-sum(is.na(x))))
  return(lower)
}

ci_upper <- function(x) {
  upper <- mean(x, na.rm=T) + (qnorm(0.975) * sd(x, na.rm = T)/sqrt(length(x)-sum(is.na(x))))
  return(upper)
}


test <- ons %>%
  dplyr::ungroup() %>%
  dplyr::select(code, all_ages) %>%
  dplyr::distinct()

des_stats(test$all_ages)
````



Summarising the regions with the most and the least cases and overall deaths from covid-19
````{r, echo = FALSE}

colnames(ons)
ons_temp <- ons %>%
              dplyr::select(code, name, total_covid_cases, total_covid_deaths, total_covid_deaths_home, total_covid_deaths_hospital, total_covid_deaths_hospice,
                     total_covid_deaths_communal_establishement, total_covid_deaths_elsewhere, total_covid_deaths_carehome,
                     total_covid_cases_trans, total_covid_deaths_trans, total_covid_deaths_home_trans, total_covid_deaths_hospital_trans,
                     total_covid_deaths_hospice_trans, total_covid_deaths_communal_establishement_trans, total_covid_deaths_elsewhere_trans, total_covid_deaths_carehome_trans, 
                     total_covid_deaths_carehome) %>%
              dplyr::distinct()

num_cases <- length(ons_temp$total_covid_cases) - sum(is.na(ons_temp$total_covid_cases))
num_deaths <- length(ons_temp$total_covid_deaths) - sum(is.na(ons_temp$total_covid_deaths))
num_cases_home <- length(ons_temp$total_covid_deaths_home) - sum(is.na(ons_temp$total_covid_deaths_home))
num_cases_hospital <- length(ons_temp$total_covid_deaths_hospital) - sum(is.na(ons_temp$total_covid_deaths_hospital))
num_cases_hospice <- length(ons_temp$total_covid_deaths_hospice) - sum(is.na(ons_temp$total_covid_deaths_hospice))
num_cases_carehome <- length(ons_temp$total_covid_deaths_carehome) - sum(is.na(ons_temp$total_covid_deaths_carehome))
num_cases_communal_establishement <- length(ons_temp$total_covid_deaths_communal_establishement) - sum(is.na(ons_temp$total_covid_deaths_communal_establlishement))
num_cases_elsewhere <- length(ons_temp$total_covid_deaths_elsewhere) - sum(is.na(ons_temp$total_covid_deaths_elsewhere))

num_cases #355
num_deaths #355
num_cases_home #355
num_cases_hospital #355
num_cases_hospice #355
num_cases_carehome #355
num_cases_communal_establishement #355
num_cases_elsewhere #355



#--- getting min, max, median and mean of the total number of cases
#---getting the sumamry statistics of total lab cases
ons_temp %$% 
      summary(total_covid_cases)
ci_mean(x = ons_temp$total_covid_cases, n =  355)
ons_temp %$%
  ci_mean_log(x = total_covid_cases_trans, n = 355)

#--- identifying which  regions contains the min and the max of the cases
ons_temp$name <- as.character(ons_temp$name)
ons_temp$name[which.min(ons_temp$total_covid_cases)]
ons_temp$name[which.max(ons_temp$total_covid_cases)]



#---getting the summary statistics of all deaths
ons_temp %$% 
      summary(total_covid_deaths)
ons_temp %$% 
  ci_mean(x = total_covid_deaths, n =  355)
ons_temp %$%
  ci_mean_log(x = total_covid_deaths_trans, n = 355)


#---identifying the names with min and max
ons_temp$name[which.min(ons_temp$total_covid_deaths)]
ons_temp$name[which.max(ons_temp$total_covid_deaths)]



#--- summarising the cases at home

ons_temp %$% 
      summary(total_covid_deaths_home)
ons_temp %$% 
  ci_mean(x = total_covid_deaths_home, n =  355)
ons_temp %$%
  ci_mean_log(x = total_covid_deaths_home_trans, n = 355)

ons_temp$name[which.min(ons_temp$total_covid_deaths_home)]
ons_temp$name[which.max(ons_temp$total_covid_deaths_home)]

#--- summarising the cases in hospitals
ons_temp %$% 
      summary(total_covid_deaths_hospital)
ons_temp %$% 
  ci_mean(x = total_covid_deaths_hospital, n =  355)
ons_temp %$%
  ci_mean_log(x = total_covid_deaths_hospital_trans, n = 355)
  

ons_temp$name[which.min(ons_temp$total_covid_deaths_hospital)]
ons_temp$name[which.max(ons_temp$total_covid_deaths_hospital)]

#--- summarising the cases in hospices
ons_temp %$% 
      summary(total_covid_deaths_hospice)
ons_temp %$% 
  ci_mean(x = total_covid_deaths_hospice, n =  355)
ons_temp %$%
  ci_mean_log(x = total_covid_deaths_hospice_trans, n = 355)
ons_temp$name[which.min(ons_temp$total_covid_deaths_hospice)]
ons_temp$name[which.max(ons_temp$total_covid_deaths_hospice)]



#--- summarising the cases in communal establishments
ons_temp %$% 
      summary(total_covid_deaths_communal_establishement)
ons_temp %$% 
  ci_mean(x = total_covid_deaths_communal_establishement, n =  355)
ons_temp %$%
  ci_mean_log(x = total_covid_deaths_communal_establishement_trans, n = 355)
ons_temp$name[which.min(ons_temp$total_covid_deaths_communal_establishement)]
ons_temp$name[which.max(ons_temp$total_covid_deaths_communal_establishement)]



#--- summarising the cases care homes
ons_temp %$% 
      summary(total_covid_deaths_carehome)
ons_temp %$% 
  ci_mean(x = total_covid_deaths_carehome, n =  355)
ons_temp %$%
  ci_mean_log(x = total_covid_deaths_carehome_trans, n = 355)
ons_temp$name[which.min(ons_temp$total_covid_deaths_carehome)]
ons_temp$name[which.max(ons_temp$total_covid_deaths_carehome)]

#--- summarising cases elsewhere
ons_temp %$% 
      summary(total_covid_deaths_elsewhere)
ons_temp %$% 
  ci_mean(total_covid_deaths_elsewhere, n = 355)
ons_temp %$%
  ci_mean_log(x = total_covid_deaths_elsewhere_trans, n = 355)
ons_temp$name[which.min(ons_temp$total_covid_deaths_elsewhere)]
ons_temp$name[which.max(ons_temp$total_covid_deaths_elsewhere)]

remove(ons_temp)

````

Summarising the case and overall covid death prevalence ratio per LA

````{r, echo = FALSE}
ons_temp <- ons %>%
              dplyr::select(code, name, covid_cases_ratio, covid_deaths_ratio, covid_deaths_home_ratio, covid_deaths_hospital_ratio,
                           covid_deaths_hospice_ratio, covid_deaths_communal_establishement_ratio, covid_deaths_elsewhere_ratio,
                           covid_deaths_carehome_ratio) %>%
              dplyr::distinct()

num_cases <- length(ons_temp$covid_cases_ratio) - sum(is.na(ons_temp$covid_cases_ratio))
num_deaths <- length(ons_temp$covid_deaths_ratio) - sum(is.na(ons_temp$covid_deaths_ratio))
num_cases_home <- length(ons_temp$covid_deaths_home_ratio) - sum(is.na(ons_temp$covid_deaths_home_ratio))
num_cases_hospital <- length(ons_temp$covid_deaths_hospital_ratio) - sum(is.na(ons_temp$covid_deaths_hospital_ratio))
num_cases_hospice <- length(ons_temp$covid_deaths_hospice_ratio) - sum(is.na(ons_temp$covid_deaths_hospice_ratio))
num_cases_carehome <- length(ons_temp$covid_deaths_carehome_ratio) - sum(is.na(ons_temp$covid_deaths_carehome_ratio))
num_cases_communal_establishement <- length(ons_temp$covid_deaths_communal_establishement_ratio) - 
                                      sum(is.na(ons_temp$covid_deaths_communal_establlishement_ratio))
num_cases_elsewhere <- length(ons_temp$covid_deaths_elsewhere_ratio) - sum(is.na(ons_temp$covid_deaths_elsewhere_ratio))

num_cases #353
num_deaths #353
num_cases_home #353
num_cases_hospital #353
num_cases_hospice #353
num_cases_carehome #353
num_cases_communal_establishement #353
num_cases_elsewhere #353


#--- getting min, max, median and mean of the total number of cases
#---getting the sumamry statistics of total lab cases
ons_temp %$% 
      summary(covid_cases_ratio)
ons_temp %$% 
  ci_mean(x = covid_cases_ratio, n = 353)
#--- identifying whic regions contains the min and the max of the cases
ons_temp$name <- as.character(ons_temp$name)
ons_temp$name[which.min(ons_temp$covid_cases_ratio)]
ons_temp$name[which.max(ons_temp$covid_cases_ratio)]

#---getting the summary statistics of all deaths
ons_temp %$% 
      summary(covid_deaths_ratio)
ons_temp %$% 
  ci_mean(x = covid_deaths_ratio, n = 353)
#---identifying the names with min and max
ons_temp$name[which.min(ons_temp$covid_deaths_ratio)]
ons_temp$name[which.max(ons_temp$covid_deaths_ratio)]


#---summary stats for prevalence ratio at home
ons_temp %$% 
      summary(covid_deaths_home_ratio)
ons_temp %$% 
  ci_mean(x = covid_deaths_home_ratio, n = 353)
ons_temp$name[which.min(ons_temp$covid_deaths_home_ratio)]
ons_temp$name[which.max(ons_temp$covid_deaths_home_ratio)]

#---summary stats for prevalence ratio in hospital
ons_temp %$% 
      summary(covid_deaths_hospital_ratio)
ons_temp %$% 
  ci_mean(x = covid_deaths_hospital_ratio, n = 353)
ons_temp$name[which.min(ons_temp$covid_deaths_hospital_ratio)]
ons_temp$name[which.max(ons_temp$covid_deaths_hospital_ratio)]

#---summary stats for prevalence ratio in care homes
ons_temp %$% 
      summary(covid_deaths_carehome_ratio)
ons_temp %$% 
  ci_mean(x = covid_deaths_carehome_ratio, n = 353)
ons_temp$name[which.min(ons_temp$covid_deaths_carehome_ratio)]
ons_temp$name[which.max(ons_temp$covid_deaths_carehome_ratio)]


#---summary stats for prevalence ratio in hospices
ons_temp %$% 
      summary(covid_deaths_hospice_ratio)
ons_temp %$% 
  ci_mean(x = covid_deaths_hospice_ratio, n = 353)
ons_temp$name[which.min(ons_temp$covid_deaths_hospice_ratio)]
ons_temp$name[which.max(ons_temp$covid_deaths_hospice_ratio)]

#---summary stats for prevalence ratio in communal establishements
ons_temp %$% 
      summary(covid_deaths_communal_establishement_ratio)
ons_temp %$% 
  ci_mean(x = covid_deaths_communal_establishement_ratio, n = 353)
ons_temp$name[which.min(ons_temp$covid_deaths_communal_establishement_ratio)]
ons_temp$name[which.max(ons_temp$covid_deaths_communal_establishement_ratio)]

#---summary stats for prevalence ratio in elsewhere
ons_temp %$% 
      summary(covid_deaths_elsewhere_ratio)
ons_temp %$% 
  ci_mean(x = covid_deaths_communal_establishement_ratio, n = 353)
ons_temp$name[which.min(ons_temp$covid_deaths_elsewhere_ratio)]
ons_temp$name[which.max(ons_temp$covid_deaths_elsewhere_ratio)]

remove(ons_temp)
````


Sumamry statistics of mortality and CFR
````{r, echo = FALSE}
#---calculation for mortality
# ons_temp <- ons %>%
#   dplyr::select(code, name, mortality) %>%
#   dplyr::distinct()
# num_mort <- length(ons_temp$mortality) - sum(is.na(ons$mortality))  
# num_mort  ##n = 308
# ons_temp %$% 
#       summary(mortality)
# ons_temp %$% 
#   ci_mean(x = mortality, n = 308)
# ons_temp$name[which.min(ons_temp$mortality)]
# ons_temp$name[which.max(ons_temp$mortality)]

colnames(ons)

#--- summary stats for the CFR
ons_temp <- ons %>%
  dplyr::filter(week >=9 & week <=21) %>%
  dplyr::select(code, name, weekly_cfr_overall_adj, weekly_cfr_overall_adj_lb, weekly_cfr_overall_adj_ub) %>%
  dplyr::distinct()
num_cfr <- length(ons_temp$weekly_cfr_overall_adj) - sum(is.na(ons_temp$weekly_cfr_overall_adj))  
num_cfr  ##n = 3465
ons_temp %>%
  summarise(mean_cfr = mean(weekly_cfr_overall_adj, na.rm = TRUE),
            mean_cfr_lb = mean(weekly_cfr_overall_adj_lb, na.rm = TRUE),
            mean_cfr_ub =mean(weekly_cfr_overall_adj_ub, na.rm = TRUE),
            SE_cfr_overall = SE(weekly_cfr_overall_adj)) %>%
  summarise(overall_mean_cfr = mean(mean_cfr),
            overall_mean_cfr_lb = mean(mean_cfr_lb),
            overall_mean_cfr_ub = mean(mean_cfr_ub),
            overall_SE_cfr_overall = mean(SE_cfr_overall))

ons_temp$name[which.min(ons_temp$weekly_cfr_overall_adj)]
ons_temp$name[which.max(ons_temp$weekly_cfr_overall_adj)]

#--- summary stats for the CFR in hospitals
ons_temp <- ons %>%
  dplyr::filter(week >=9 & week <=21) %>%
  dplyr::select(code, name, weekly_cfr_hospital_adj, weekly_cfr_hospital_adj_lb, weekly_cfr_hospital_adj_ub) %>%
  dplyr::distinct()
num_cfr <- length(ons_temp$weekly_cfr_hospital_adj) - sum(is.na(ons_temp$weekly_cfr_hospital_adj))  
num_cfr  ##n = 3465
ons_temp %>%
  summarise(mean_cfr = mean(weekly_cfr_hospital_adj, na.rm = TRUE),
            mean_cfr_lb = mean(weekly_cfr_hospital_adj_lb, na.rm = TRUE),
            mean_cfr_ub =mean(weekly_cfr_hospital_adj_ub, na.rm = TRUE),
            SE_cfr_overall = SE(weekly_cfr_hospital_adj)) %>%
  summarise(overall_mean_cfr = mean(mean_cfr),
            overall_mean_cfr_lb = mean(mean_cfr_lb),
            overall_mean_cfr_ub = mean(mean_cfr_ub),
            overall_SE_cfr_overall = mean(SE_cfr_overall))

ons_temp$name[which.min(ons_temp$weekly_cfr_hospital_adj)]
ons_temp$name[which.max(ons_temp$weekly_cfr_hospital_adj)]

````

Summary of overall case and mortality rate and mortality in different settings
````{r, echo = FALSE}
colnames(ons)
ons_temp <- ons %>%
  dplyr::select(code, mortality_overall, mortality_hospital, mortality_carehome, mortality_home, mortality_hospice, mortality_communal_establishement,
                mortality_elsewhere) %>%
  dplyr::distinct()
n_mortality_overall <- length(ons_temp$mortality_overall) - sum(is.na(ons$mortality_overall))
n_mortality_hospital <- length(ons_temp$mortality_hospital) - sum(is.na(ons$mortality_hospital)) 
n_mortality_home <- length(ons_temp$mortality_home) - sum(is.na(ons$mortality_home)) 
n_mortality_carehome <- length(ons_temp$mortality_carehome) - sum(is.na(ons$mortality_carehome)) 
n_mortality_hospice <- length(ons_temp$mortality_hospice) - sum(is.na(ons$mortality_hospice)) 
n_mortality_communal_establishement <- length(ons_temp$mortality_communal_establishement) - sum(is.na(ons$mortality_communal_establishement)) 
n_mortality_elsewhere <- length(ons_temp$mortality_elsewhere) - sum(is.na(ons$mortality_elsewhere))
n_mortality_overall
n_mortality_hospital
n_mortality_home
n_mortality_carehome
n_mortality_hospice
n_mortality_communal_establishement
n_mortality_elsewhere #308 for all

#--overall weekly mortality
ons_temp %$%
  summary(mortality_overall)
ons_temp %$%
  mean(mortality_overall, na.rm = TRUE)
ons_temp %$%
  sd(mortality_overall, na.rm = TRUE)
ons_temp %$%
  ci_lower(mortality_overall)
ons_temp %$%
  ci_upper(mortality_overall)


#--overall weekly mortality in hospitals
ons_temp %$%
  summary(mortality_hospital)
ons_temp %$%
  mean(mortality_hospital, na.rm = TRUE)
ons_temp %$%
  sd(mortality_hospital, na.rm = TRUE)
ons_temp %$%
  ci_lower(mortality_hospital)
ons_temp %$%
  ci_upper(mortality_hospital)


#--overall weekly mortality in home
ons_temp %$%
  summary(mortality_home)
ons_temp %$%
  mean(mortality_home, na.rm = TRUE)
ons_temp %$%
  sd(mortality_home, na.rm = TRUE)
ons_temp %$%
  ci_lower(mortality_home)
ons_temp %$%
  ci_upper(mortality_home)


#--overall weekly mortality in carehomes
ons_temp %$%
  summary(mortality_carehome)
ons_temp %$%
  mean(mortality_carehome, na.rm = TRUE)
ons_temp %$%
  sd(mortality_carehome, na.rm = TRUE)
ons_temp %$%
  ci_lower(mortality_carehome)
ons_temp %$%
  ci_upper(mortality_carehome)

#--overall weekly mortality in hospices
ons_temp %$%
  summary(mortality_hospice)
ons_temp %$%
  mean(mortality_hospice, na.rm = TRUE)
ons_temp %$%
  sd(mortality_hospice, na.rm = TRUE)
ons_temp %$%
  ci_lower(mortality_hospice)
ons_temp %$%
  ci_upper(mortality_hospice)

#--overall weekly mortality in communal establishements
ons_temp %$%
  summary(mortality_communal_establishement)
ons_temp %$%
  mean(mortality_communal_establishement, na.rm = TRUE)
ons_temp %$%
  sd(mortality_communal_establishement, na.rm = TRUE)
ons_temp %$%
  ci_lower(mortality_communal_establishement)
ons_temp %$%
  ci_upper(mortality_communal_establishement)

#--overall weekly mortality elsewhere
ons_temp %$%
  summary(mortality_elsewhere)
ons_temp %$%
  mean(mortality_elsewhere, na.rm = TRUE)
ons_temp %$%
  sd(mortality_elsewhere, na.rm = TRUE)
ons_temp %$%
  ci_lower(mortality_elsewhere)
ons_temp %$%
  ci_upper(mortality_elsewhere)
````





Mapping the prevalence of cases and deaths per LA
````{r, echo = FALSE}
#--- mapping the index of multiple deprivation per LA
#--- Upload of the LA file
LA_shape <- readOGR(dsn = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/shape_files/LA", 
                    layer ="Local_Authority_Districts__December_2017__Boundaries_in_the_UK__WGS84_")


#--- turns the  weird polygonal shape file into a normal data frame
tidy_LA <- broom::tidy(LA_shape)


#--- creating a temporary dataframe to recover the name of all original file region names
temp_df <- data.frame(LA_shape@data$lad17cd)
names(temp_df) <- c("region")
temp_df$id <- seq(0, nrow(temp_df) - 1) ##extracting the ids used by the initial shapefile polygon



#--- this joins your new tidy dataframe with lat, long and unique IDs to the temporary one
#--- with region names in English
tidy_LA_with_regions <- tidy_LA %>%
  dplyr::mutate(id = as.integer(id)) %>%
  dplyr::left_join(temp_df)

tidy_LA_with_regions <- tidy_LA_with_regions %>%
                          dplyr::rename(code = region)
````

Maps of deaths and cases
````{r, include = FALSE}
#--- reducing the size of the massive triage dataframe
ons_map <- ons %>%
              dplyr::select(code, name, covid_cases_ratio, covid_deaths_ratio, covid_deaths_home_ratio, covid_deaths_hospital_ratio,
                           covid_deaths_carehome_ratio, prop_most_deprived, total_covid_cases, total_covid_deaths) %>%
              dplyr::distinct()
head(ons_map)

#--- joins together the look-up table and then the triage data to be plotted
#--- into one single whopping data frame. Its really big because many rows are repeated
#--- but dplyr::distinct() keeps only the distinct rows
tidy_LA_with_regions_new <- tidy_LA_with_regions %>%
  dplyr::left_join(ons_map, by = "code") %>%
  dplyr::distinct()


#---map for the total number of cases per LA
map_total_cases <- tidy_LA_with_regions_new %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_polygon(ggplot2::aes(x = long, y = lat, group = group, fill = total_covid_cases), colour = "black") + 
                    ggplot2::theme(legend.position = "none") +

                    ggplot2::labs(title = "Absolute number of lab-based COVID-19 cases per local authority in England",
                                  fill = "total number of cases") +
                    ggplot2::theme(axis.title.x=element_blank(),
                                   axis.text.x=element_blank(),
                                   axis.ticks.x=element_blank(),
                                   axis.title.y=element_blank(),
                                   axis.text.y=element_blank(),
                                   axis.ticks.y=element_blank(),
                                   legend.position = "bottom",
                                  legend.title = element_text()) +
                    ggplot2::scale_fill_gradient2(low = "deepskyblue1",   high = "deepskyblue4",  space = "Lab",  na.value = "grey50",  guide = "colourbar",
                                                  aesthetics = "fill")

ggsave(filename = "total_cases.jpeg", plot = map_total_cases, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/final maps", 
        width = 210, height = 297, units = c("mm"), dpi = 300, limitsize = TRUE)

#---map of the prevalence ratio of cases per 100,000 inhabitants per LA
map_case_ratio <- tidy_LA_with_regions_new %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_polygon(ggplot2::aes(x = long, y = lat, group = group, fill = covid_cases_ratio), colour = "black") + 
                    ggplot2::theme(legend.position = "none") +

                    ggplot2::labs(title = "Relative number of COVID-19 cases per local authority in England",
                                  fill = "cases per 100,000") +
                    ggplot2::theme(axis.title.x=element_blank(),
                                   axis.text.x=element_blank(),
                                   axis.ticks.x=element_blank(),
                                   axis.title.y=element_blank(),
                                   axis.text.y=element_blank(),
                                   axis.ticks.y=element_blank(),
                                   legend.position = "bottom",
                                  legend.title = element_text()) +
                    ggplot2::scale_fill_gradient2(low = "deepskyblue1",   high = "deepskyblue4",  space = "Lab",  na.value = "grey50",  guide = "colourbar",
                                                  aesthetics = "fill")

ggsave(filename = "case_ratio.jpeg", plot = map_case_ratio, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/final maps", 
        width = 210, height = 297, units = c("mm"), dpi = 300, limitsize = TRUE)

#---map for the total number of deaths  per LA
map_total_deaths <- tidy_LA_with_regions_new %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_polygon(ggplot2::aes(x = long, y = lat, group = group, fill = total_covid_deaths), colour = "black") + 
                    ggplot2::theme(legend.position = "none") +

                    ggplot2::labs(title = "Absolute number of  COVID-19 deaths per local authority in England",
                                  fill = "total number of registered deaths") +
                    ggplot2::theme(axis.title.x=element_blank(),
                                   axis.text.x=element_blank(),
                                   axis.ticks.x=element_blank(),
                                   axis.title.y=element_blank(),
                                   axis.text.y=element_blank(),
                                   axis.ticks.y=element_blank(),
                                   legend.position = "bottom",
                                  legend.title = element_text()) +
                    ggplot2::scale_fill_gradient2(low = "deepskyblue1",   high = "deepskyblue4",  space = "Lab",  na.value = "grey50",  guide = "colourbar",
                                                  aesthetics = "fill")

ggsave(filename = "total_deaths.jpeg", plot = map_total_deaths, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/final maps", 
        width = 210, height = 297, units = c("mm"), dpi = 300, limitsize = TRUE)

#---map of the prevalence ratio of cases per 100,000 inhabitants per LA
map_death_ratio <- tidy_LA_with_regions_new %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_polygon(ggplot2::aes(x = long, y = lat, group = group, fill = covid_deaths_ratio), colour = "black") + 
                    ggplot2::theme(legend.position = "none") +

                    ggplot2::labs(title = "Relative number of COVID-19 deaths per local authority in England",
                                  fill = "deaths per 100,000") +
                    ggplot2::theme(axis.title.x=element_blank(),
                                   axis.text.x=element_blank(),
                                   axis.ticks.x=element_blank(),
                                   axis.title.y=element_blank(),
                                   axis.text.y=element_blank(),
                                   axis.ticks.y=element_blank(),
                                   legend.position = "bottom",
                                  legend.title = element_text()) +
                    ggplot2::scale_fill_gradient2(low = "deepskyblue1",   high = "deepskyblue4",  space = "Lab",  na.value = "grey50",  guide = "colourbar",
                                                  aesthetics = "fill")

ggsave(filename = "death_ratio.jpeg", plot = map_death_ratio, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/final maps", 
        width = 210, height = 297, units = c("mm"), dpi = 300, limitsize = TRUE)



#---map of the prevalence ratio of cases per 100,000 inhabitants per LA
map_death_ratio_hospital <- tidy_LA_with_regions_new %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_polygon(ggplot2::aes(x = long, y = lat, group = group, fill = covid_deaths_hospital_ratio), colour = "black") + 
                    ggplot2::theme(legend.position = "none") +

                    ggplot2::labs(title = "COVID-19 deaths in hospitals per local authority in England",
                                  fill = "deaths per 100,000") +
                    ggplot2::theme(axis.title.x=element_blank(),
                                   axis.text.x=element_blank(),
                                   axis.ticks.x=element_blank(),
                                   axis.title.y=element_blank(),
                                   axis.text.y=element_blank(),
                                   axis.ticks.y=element_blank(),
                                   legend.position = "bottom",
                                  legend.title = element_text()) +
                    ggplot2::scale_fill_gradient2(low = "deepskyblue1",   high = "deepskyblue4",  space = "Lab",  na.value = "grey50",  guide = "colourbar",
                                                  aesthetics = "fill")

ggsave(filename = "death_ratio_hospital.jpeg", plot = map_death_ratio_hospital, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/final maps", 
        width = 210, height = 297, units = c("mm"), dpi = 300, limitsize = TRUE)


#---map of the prevalence ratio of cases per 100,000 inhabitants per LA
map_death_ratio_home <- tidy_LA_with_regions_new %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_polygon(ggplot2::aes(x = long, y = lat, group = group, fill = covid_deaths_home_ratio), colour = "black") + 
                    ggplot2::theme(legend.position = "none") +

                    ggplot2::labs(title = "COVID-19 deaths at home per local authority in England",
                                  fill = " deaths  per 100,000") +
                    ggplot2::theme(axis.title.x=element_blank(),
                                   axis.text.x=element_blank(),
                                   axis.ticks.x=element_blank(),
                                   axis.title.y=element_blank(),
                                   axis.text.y=element_blank(),
                                   axis.ticks.y=element_blank(),
                                   legend.position = "bottom",
                                  legend.title = element_text()) +
                    ggplot2::scale_fill_gradient2(low = "deepskyblue1",   high = "deepskyblue4",  space = "Lab",  na.value = "grey50",  guide = "colourbar",
                                                  aesthetics = "fill")

ggsave(filename = "death_ratio_home.jpeg", plot = map_death_ratio_home, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/final maps", 
        width = 210, height = 297, units = c("mm"), dpi = 300, limitsize = TRUE)



#---map of the prevalence ratio of cases per 100,000 inhabitants per LA
map_death_ratio_carehome <- tidy_LA_with_regions_new %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_polygon(ggplot2::aes(x = long, y = lat, group = group, fill = covid_deaths_carehome_ratio), colour = "black") + 
                    ggplot2::theme(legend.position = "none") +

                    ggplot2::labs(title = "COVID-19 deaths in carehomes  per local authority in England",
                                  fill = "deaths per 100,000") +
                    ggplot2::theme(axis.title.x=element_blank(),
                                   axis.text.x=element_blank(),
                                   axis.ticks.x=element_blank(),
                                   axis.title.y=element_blank(),
                                   axis.text.y=element_blank(),
                                   axis.ticks.y=element_blank(),
                                   legend.position = "bottom",
                                  legend.title = element_text()) +
                    ggplot2::scale_fill_gradient2(low = "deepskyblue1",   high = "deepskyblue4",  space = "Lab",  na.value = "grey50",  guide = "colourbar",
                                                  aesthetics = "fill")

ggsave(filename = "death_ratio_carehome.jpeg", plot = map_death_ratio_carehome, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/final maps", 
        width = 210, height = 297, units = c("mm"), dpi = 300, limitsize = TRUE)



````





Mapping the IMD for different LA
````{r, echo = FALSE}


#--- reducing the size of the massive triage dataframe
ons_map <- ons %>%
              dplyr::select(code, name, imd_5s) %>%
              dplyr::distinct()
head(ons_map)

#--- joins together the look-up table and then the triage data to be plotted
#--- into one single whopping data frame. Its really big because many rows are repeated
#--- but dplyr::distinct() keeps only the distinct rows
tidy_LA_with_regions_new <- tidy_LA_with_regions %>%
  dplyr::left_join(ons_map, by = "code") %>%
  dplyr::distinct()

 
#--- final map 
tidy_LA_with_regions_new$imd_5s <- as.factor(tidy_LA_with_regions_new$imd_5s)
color_imd <- c( "tan",  "darkorange2",  "yellow", "yellowgreen",  "green4")

map_imd <- tidy_LA_with_regions_new %>%
                    ggplot2::ggplot() + 
                    ggplot2::geom_polygon(ggplot2::aes(x = long, y = lat, group = group, fill = imd_5s), color = "black") + 
                    ggplot2::theme(legend.position = "none") +
                    ggplot2::scale_fill_manual(values = color_imd)+
                    ggplot2::labs(title = "Index of multiple deprivation per local authority",
                                  fill =  "Quintile of IMD") +
                     theme(plot.title = element_text(hjust = 0.5, size = 18, face = "bold"),
                    legend.title = element_text(size = 12, face = "bold"),
                    legend.text = element_text(size=12),
                    axis.title.x=element_blank(),
                    axis.text.x=element_blank(),
                    axis.ticks.x=element_blank(),
                    axis.title.y=element_blank(),
                    axis.text.y=element_blank(),
                    axis.ticks.y=element_blank(),
                    legend.position = "bottom",
                    panel.grid.major = element_blank(),
                    panel.grid.minor = element_blank())+
                  guides(color = FALSE)



ggsave(filename = "map_IMD_prop.jpeg", plot = map_imd, 
       path = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/final maps", 
        width = 210, height = 297, units = c("mm"), dpi = 300, limitsize = TRUE)

map_imd

````

Plotting the explanatory variables
````{r, echo = FALSE}
#---percentage of young population
ggplot(data = ons) + 
  geom_point(mapping = aes(x = code, y =pop_under_19_per))

ggplot(data=ons, aes(pop_under_19_per)) + 
  geom_histogram()
ggplot(data=ons, aes(pop_over_65)) + 
  geom_histogram() ##skewed
ggplot(data=ons, aes(female_per)) + 
  geom_histogram()
ggplot(data=ons, aes(BAME_per)) + 
  geom_histogram() #skewed
ggplot(data=ons, aes(obs_ratio)) + 
  geom_histogram() #skewed
ggplot(data=ons, aes(diab_ratio)) + 
  geom_histogram() 
ggplot(data=ons, aes(hyper_ratio)) + 
  geom_histogram() #nskewed

#--_log transformation of skewed data
ons <- ons %>%
  dplyr::mutate(BAME_per_log = log(BAME_per, base = exp(1)),
                BAME_per_log1 = log((BAME_per+1), base = exp(1)),
                obs_ratio_log = log(obs_ratio, base = exp(1)),
                obs_ratio_log1 = log((obs_ratio+1), base = exp(1)),
                hyper_ratio_log = log(hyper_ratio, base = exp(1)),
                hyper_ratio_log1 = log((hyper_ratio+1), base = exp(1)))



ggplot(data=ons, aes(BAME_per_log)) + 
  geom_histogram() 
ggplot(data=ons, aes(obs_ratio_log)) + 
  geom_histogram() 
ggplot(data=ons, aes(hyper_ratio_log)) + 
  geom_histogram()
````



Descriptive Stats of the explanatory variables 
```{r, echo =FALSE} 
ons_temp <- ons %>%
              dplyr::select(code, name, male_per, female_per, BAME_per, obs_tot, diab_tot, hyper_tot, obs_ratio, diab_ratio, hyper_ratio,
                            pop_under_19, pop_under_19_per, pop_under_50, pop_under_50_per, pop_over_50, pop_over_50_per ,pop_over_65,
                            pop_over_65_per, pop_over_70, pop_over_70_per, diab_ratio, hyper_ratio, obs_ratio, imd_10, obs_ratio_log,
                            hyper_ratio_log, BAME_per_log, BAME_per_log1, obs_ratio_log1, hyper_ratio_log1) %>%
              dplyr::distinct()
View(ons_temp)

#---summarising the age
num_youngster <- length(ons_temp$pop_under_19_per) - sum(is.na(ons_temp$pop_under_19_per))  
num_youngster #308
num_oldies <- length(ons_temp$pop_over_65_per) - sum(is.na(ons_temp$pop_over_65_per)) 
num_oldies #308
#---young population under 19 years (0-18 years)
ons_temp %$%
  summary(pop_under_19_per)
ons_temp %$%
  ci_mean(pop_under_19_per, n=308)
ons_temp$name[which.min(ons_temp$pop_under_19_per)]
ons_temp$name[which.max(ons_temp$pop_under_19_per)]
 
#--- older population from 65 and older 
ons_temp %$%
  summary(pop_over_65_per)
ons_temp %$%
  ci_mean(pop_over_65_per, n=308)
ons_temp%$%
  ci_mean_ln(pop_over_65_log, n=308)

summary(ons_temp$pop_over_65_log)
exp(10.261)
ons_temp$name[which.min(ons_temp$pop_over_65_per)]
ons_temp$name[which.max(ons_temp$pop_over_65_per)]

#--- summarising proportion of female population
num_females <- length(ons_temp$female_per) - sum(is.na(ons_temp$female_per))  
num_females #308
ons_temp %$%
  summary(female_per)
ons_temp %$%
  ci_mean(female_per, n=308)
ons_temp$name[which.min(ons_temp$female_per)]
ons_temp$name[which.max(ons_temp$female_per)]

#--- summarising proportion of BAME population
num_bame <- length(ons_temp$BAME_per) - sum(is.na(ons_temp$BAME_per))  
num_bame #308
ons_temp %$%
  summary(BAME_per)
ons_temp %$%
  ci_mean(BAME_per, n=308)
ons_temp %$%
  ci_mean_log(BAME_per_log1, n=308)
ons_temp$name[which.min(ons_temp$female_per)]
ons_temp$name[which.max(ons_temp$female_per)]

#---summarising the prevalence of obesity per 100,000 across the local authorities
num_obs <- length(ons_temp$obs_ratio) - sum(is.na(ons_temp$obs_ratio))  
num_obs #119
ons_temp %$%
  summary(obs_ratio)
ons_temp %$%
  ci_mean(obs_ratio, n=119)
ons_temp %$%
  ci_mean_log(obs_ratio_log1, n = 119)
ons_temp$name[which.min(ons_temp$obs_ratio)]
ons_temp$name[which.max(ons_temp$obs_ratio)]

#---summarising the prevalence of diabetes per 100,000 across the local authorities
num_diab <- length(ons_temp$diab_ratio) - sum(is.na(ons_temp$diab_ratio))  
num_diab #119
ons_temp %$%
  summary(diab_ratio)
ons_temp %$%
  ci_mean(diab_ratio, n=119)
ons_temp$name[which.min(ons_temp$diab_ratio)]
ons_temp$name[which.max(ons_temp$diab_ratio)]


#---summarising the prevalence of hypertension per 100,000 across the local authorities
num_hyper <- length(ons_temp$hyper_ratio) - sum(is.na(ons_temp$hyper_ratio))  
num_hyper #119
ons_temp %$%
  summary(hyper_ratio)
ons_temp %$%
  ci_mean(hyper_ratio, n=119)
ons_temp %$%
  ci_mean_ln(hyper_ratio_log1, n = 119)
ons_temp$name[which.min(ons_temp$hyper_ratio)]
ons_temp$name[which.max(ons_temp$hyper_ratio)]
````



Now: descriptive statistics stratified by imd_decile for the other explanatory variables

```{r,  echo = FALSE}
colnames(ons)
)

ons_temp <- ons %>%
              dplyr::select(code, name, male_per, female_per, BAME_per, obs_tot, diab_tot, hyper_tot, obs_ratio, diab_ratio, hyper_ratio,
                            pop_under_19, pop_under_19_per, pop_under_50, pop_under_50_per, pop_over_50, pop_over_50_per ,pop_over_65,
                            pop_over_65_per, pop_over_70, pop_over_70_per, diab_ratio, hyper_ratio, obs_ratio, imd_10, obs_ratio_log,
                            hyper_ratio_log, BAME_per_log, BAME_per_log1,  obs_ratio_log1, hyper_ratio_log1) %>%
              dplyr::distinct()
colnames(ons)
#---number of entries after stratification
ons_temp %>% 
  group_by(imd_10) %>%
  summarise(no_rows = length(imd_10))


#---population under 19
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_pop_under_19 = mean(pop_under_19_per, na.rm= TRUE),
             mean_pop_under_19_ci_low = ci_lower(pop_under_19_per),
             mean_pop_under_19_ci_up = ci_upper(pop_under_19_per),
             sd_pop_under_19 = sd(pop_under_19_per, na.rm= TRUE),
             SE_pop_under_19 = SE(pop_under_19_per))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_pop_under_19, mean_pop_under_19_ci_low, mean_pop_under_19_ci_up, sd_pop_under_19, SE_pop_under_19) %>%
   dplyr::distinct()

plot_pop_under_19 <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_pop_under_19, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Proportion of population under 19 years by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "% of population under 19") + 
  ggplot2::geom_errorbar(aes(ymin = mean_pop_under_19_ci_low, ymax = mean_pop_under_19_ci_up  ))
plot_pop_under_19

# ons_temp <- ons_temp %>%
  # dplyr::select(code, imd_10,mean_pop_under_19, mean_pop_under_19_ci_low, mean_pop_under_19_ci_up, sd_pop_under_19, SE_pop_under_19)
# ons <- ons %>%
#       dplyr::left_join(ons_temp, by = c("code", "imd_10")) %>%
#       dplyr::distinct()

#---population over 65
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_pop_over_65 = mean(pop_over_65_per, na.rm= TRUE),
             mean_pop_over_65_ci_low = ci_lower(pop_over_65_per),
             mean_pop_over_65_ci_up = ci_upper(pop_over_65_per),
             sd_pop_over_65 = sd(pop_over_65_per, na.rm= TRUE),
             SE_pop_over_65 = SE(pop_over_65_per))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_pop_over_65,mean_pop_over_65_ci_low, mean_pop_over_65_ci_up, sd_pop_over_65, SE_pop_over_65) %>%
   dplyr::distinct()

plot_pop_over_65 <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_pop_over_65, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Proportion of population over 64 years by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "% of population over 64") + 
  ggplot2::geom_errorbar(aes(ymin = mean_pop_over_65_ci_low, ymax = mean_pop_over_65_ci_up  ))
plot_pop_over_65
# ons_temp <- ons_temp %>%
#   dplyr::select(code, imd_10,mean_pop_over_65,mean_pop_over_65_ci_low, mean_pop_over_65_ci_up, sd_pop_over_65, SE_pop_over_65)
# ons <- ons %>%
#       dplyr::left_join(ons_temp, by = c("code", "imd_10")) %>%
#       dplyr::distinct()

#---prpoportion of female population
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_female = mean(female_per, na.rm= TRUE),
             mean_female_ci_low = ci_lower(female_per),
             mean_female_ci_up = ci_upper(female_per),
             sd_female = sd(female_per, na.rm= TRUE),
             SE_female = SE(female_per))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_female, mean_female_ci_low, sd_female, SE_female) %>%
   dplyr::distinct()

plot_female <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_female, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Proportion of female population by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "% of female population") + 
  ggplot2::geom_errorbar(aes(ymin = mean_female_ci_low, ymax = mean_female_ci_up ))
plot_female


#---prpoportion of BAME population
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_BAME = mean(BAME_per, na.rm= TRUE),
             mean_BAME_ci_low = ci_lower(BAME_per),
             mean_BAME_ci_up = ci_upper(BAME_per),
             sd_BAME = sd(BAME_per, na.rm= TRUE),
             SE_BAME = SE(BAME_per))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_BAME, mean_BAME_ci_low, sd_BAME, SE_BAME) %>%
   dplyr::distinct()

plot_BAME <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_BAME, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Proportion of BAME population by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "% of BAME population") + 
  ggplot2::geom_errorbar(aes(ymin = mean_BAME_ci_low, ymax = mean_BAME_ci_up ))
plot_BAME

ons_temp <- ons_temp %>%
  dplyr::select(code, imd_10, mean_pop_under_19, mean_pop_under_19_ci_low, mean_pop_under_19_ci_up, sd_pop_under_19, SE_pop_under_19,
                mean_pop_over_65,mean_pop_over_65_ci_low, mean_pop_over_65_ci_up, sd_pop_over_65, SE_pop_over_65,
                mean_female, mean_female_ci_low, sd_female, SE_female,
                mean_BAME, mean_BAME_ci_low, sd_BAME, SE_BAME) %>%
  dplyr::distinct()

ons <- ons %>%
  dplyr::left_join(ons_temp, by = c("code", "imd_10"))


colnames(ons)
save(ons, file = "C:/Users/Anne M. Suffel/Documents/LSHTM/master thesis/Final data sets/ons_updated.Rdata")
````



Mortality by IMD-decile
````{r, echo FALSE}
colnames(ons)

ons_temp <- ons %>%
  dplyr::select(code, imd_10, total_covid_deaths, total_covid_cases, covid_cases_ratio,  mortality_overall, mortality_hospital, mortality_carehome,
                mortality_communal_establishement, mortality_home, mortality_hospice, mortality_elsewhere)


#---plotting the overall cases by imd
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_cases_asb = mean(total_covid_cases, na.rm= TRUE),
             mean_cases_abs_ci_low = ci_lower(total_covid_cases),
             mean_cases_abs_ci_up = ci_upper(total_covid_cases),
             sd_cases_abs = sd(total_covid_cases, na.rm= TRUE),
             SE_cases_abs = SE(total_covid_cases))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_cases_asb, mean_cases_abs_ci_low,  mean_cases_abs_ci_up, sd_cases_abs, SE_cases_abs ) %>%
   dplyr::distinct()

plot_cases_absolute <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_cases_asb, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Absolute number of cases by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "absolute number of cases") + 
  ggplot2::geom_errorbar(aes(ymin = mean_cases_abs_ci_low, ymax = mean_cases_abs_ci_up ))
plot_cases_absolute




#---plotting the case prevalence
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_cases = mean(covid_cases_ratio, na.rm= TRUE),
             mean_cases_ci_low = ci_lower(covid_cases_ratio),
             mean_cases_ci_up = ci_upper(covid_cases_ratio),
             sd_cases = sd(covid_cases_ratio, na.rm= TRUE),
             SE_cases = SE(total_covid_cases))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_cases, mean_cases_ci_low,  mean_cases_ci_up, sd_cases, SE_cases) %>%
   dplyr::distinct()

plot_cases <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_cases, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Prevalence  of cases by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "COVId-19 cases per 100,000 inhabitants") + 
  ggplot2::geom_errorbar(aes(ymin = mean_cases_ci_low, ymax = mean_cases_ci_up ))
plot_cases





#---plotting the absolute number of deaths
#---plotting the overall cases by imd
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_deaths_abs = mean(total_covid_deaths, na.rm= TRUE),
             mean_deaths_abs_ci_low = ci_lower(total_covid_deaths),
             mean_deaths_abs_ci_up = ci_upper(total_covid_deaths),
             sd_deaths_abs = sd(total_covid_deaths, na.rm= TRUE),
             SE_deaths_abs = SE(total_covid_deaths))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_deaths_abs, mean_deaths_abs_ci_low,  mean_deaths_abs_ci_up, sd_deaths_abs, SE_deaths_abs ) %>%
   dplyr::distinct()

plot_deaths_absolute <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_deaths_abs, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Absolute number of deaths by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "absolute number of deaths") + 
  ggplot2::geom_errorbar(aes(ymin = mean_deaths_abs_ci_low, ymax = mean_deaths_abs_ci_up ))
plot_deaths_absolute


#---plotting the mortality rate among all settings
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_mortality = mean(mortality_overall, na.rm= TRUE),
             mean_mortality_ci_low = ci_lower(mortality_overall),
             mean_mortality_ci_up = ci_upper(mortality_overall),
             sd_mortality = sd(mortality_overall, na.rm= TRUE),
             SE_mortality = SE(mortality_overall))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_mortality,  mean_mortality_ci_low, mean_mortality_ci_up, sd_mortality, SE_mortality ) %>%
   dplyr::distinct()

plot_overall_mortality <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y =mean_mortality , fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Weekly mortality by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "weekly mortality rate per 100,000") + 
  ggplot2::geom_errorbar(aes(ymin = mean_mortality_ci_low, ymax = mean_mortality_ci_up ))
plot_overall_mortality


#---plotting the mortality rate in hospitals
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_mortality_hospital = mean(mortality_hospital, na.rm= TRUE),
             mean_mortality_hospital_ci_low = ci_lower(mortality_hospital),
             mean_mortality_hospital_ci_up = ci_upper(mortality_hospital),
             sd_mortality_hospital = sd(mortality_hospital, na.rm= TRUE),
             SE_mortality_hospital = SE(mortality_hospital))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_mortality_hospital,  mean_mortality_hospital_ci_low, mean_mortality_hospital_ci_up, sd_mortality_hospital, SE_mortality_hospital ) %>%
   dplyr::distinct()

plot_mortality_hospital <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_mortality_hospital, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Weekly mortality in hospitals by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "weekly mortality rate per 100,000") + 
  ggplot2::geom_errorbar(aes(ymin = mean_mortality_hospital_ci_low, ymax = mean_mortality_hospital_ci_up ))
plot_mortality_hospital



#---plotting the mortality rate at home
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_mortality_home = mean(mortality_home, na.rm= TRUE),
             mean_mortality_home_ci_low = ci_lower(mortality_home),
             mean_mortality_homel_ci_up = ci_upper(mortality_home),
             sd_mortality_home = sd(mortality_home, na.rm= TRUE),
             SE_mortality_home = SE(mortality_home))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_mortality_home,  mean_mortality_home_ci_low, mean_mortality_homel_ci_up, sd_mortality_home, SE_mortality_home ) %>%
   dplyr::distinct()

plot_mortality_home <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_mortality_home, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Weekly mortality at home by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "weekly mortality rate per 100,000") + 
  ggplot2::geom_errorbar(aes(ymin = mean_mortality_home_ci_low , ymax = mean_mortality_homel_ci_up ))
plot_mortality_home

#---plotting the mortality rate at carehomes
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_mortality_carehome = mean(mortality_carehome, na.rm= TRUE),
             mean_mortality_carehome_ci_low = ci_lower(mortality_carehome),
             mean_mortality_carehomel_ci_up = ci_upper(mortality_carehome),
             sd_mortality_carehome = sd(mortality_carehome, na.rm= TRUE),
             SE_mortality_carehome = SE(mortality_carehome))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_mortality_carehome,  mean_mortality_carehome_ci_low, mean_mortality_carehomel_ci_up, sd_mortality_carehome, SE_mortality_carehome ) %>%
   dplyr::distinct()

plot_mortality_carehome <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_mortality_carehome, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Weekly mortality in care homes by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "weekly mortality rate per 100,000") + 
  ggplot2::geom_errorbar(aes(ymin = mean_mortality_carehome_ci_low , ymax = mean_mortality_carehomel_ci_up ))
plot_mortality_carehome

#---plotting the mortality rate in hospices
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_mortality_hospice = mean(mortality_hospice, na.rm= TRUE),
             mean_mortality_hospice_ci_low = ci_lower(mortality_hospice),
             mean_mortality_hospice_ci_up = ci_upper(mortality_hospice),
             sd_mortality_hospice = sd(mortality_hospice, na.rm= TRUE),
             SE_mortality_hospice = SE(mortality_hospice))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_mortality_hospice, mean_mortality_hospice_ci_low,mean_mortality_hospice_ci_up,sd_mortality_hospice, SE_mortality_hospice  ) %>%
   dplyr::distinct()

plot_mortality_hospice <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_mortality_hospice, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Weekly mortality in hospices by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "weekly mortality rate per 100,000") + 
  ggplot2::geom_errorbar(aes(ymin = mean_mortality_hospice_ci_low , ymax = mean_mortality_hospice_ci_up ))
plot_mortality_hospice

#---plotting the mortality rate in communal establishements
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_mortality_com = mean(mortality_communal_establishement, na.rm= TRUE),
             mean_mortality_com_ci_low = ci_lower(mortality_communal_establishement),
             mean_mortality_com_ci_up = ci_upper(mortality_communal_establishement),
             sd_mortality_com = sd(mortality_communal_establishement, na.rm= TRUE),
             SE_mortality_com = SE(mortality_communal_establishement))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_mortality_com, mean_mortality_com_ci_low,mean_mortality_com_ci_up,sd_mortality_com, SE_mortality_com  ) %>%
   dplyr::distinct()

plot_mortality_communal_establishement <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_mortality_com, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Weekly mortality in communal establishements by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "weekly mortality rate per 100,000") + 
  ggplot2::geom_errorbar(aes(ymin = mean_mortality_com_ci_low , ymax = mean_mortality_com_ci_up ))
plot_mortality_communal_establishement


#---plotting the mortality rate elsewhere
ons_temp <- ons_temp %>%
      group_by(imd_10) %>%
      mutate(mean_mortality_else = mean(mortality_elsewhere, na.rm= TRUE),
             mean_mortality_else_ci_low = ci_lower(mortality_elsewhere),
             mean_mortality_else_ci_up = ci_upper(mortality_elsewhere),
             sd_mortality_else = sd(mortality_elsewhere, na.rm= TRUE),
             SE_mortality_else = SE(mortality_elsewhere))
ons_temp %>%
  group_by(imd_10) %>%
  summarise(mean_mortality_else, mean_mortality_else_ci_low,mean_mortality_else_ci_up,sd_mortality_else, SE_mortality_else) %>%
   dplyr::distinct()

plot_mortality_elsewhere <- 
  ggplot2::ggplot(ons_temp, aes(x = imd_10, y = mean_mortality_else, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Weekly mortality not further specified by IMD decile",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "weekly mortality rate per 100,000") + 
  ggplot2::geom_errorbar(aes(ymin = mean_mortality_else_ci_low , ymax = mean_mortality_else_ci_up ))
plot_mortality_elsewhere
````



Graphs for the comorbidities
````{r, echo = FALSE}

plot_obesity <- 
  ggplot2::ggplot(ons, aes(x = imd_10, y = obs_ratio, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Prevalence of obesity by decile of IMD",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "obesity prevalence across 100,000 inhabitants")
plot_diabetes <- 
  ggplot2::ggplot(ons, aes(x = imd_10, y = diab_ratio, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Prevalence of diabetes by decile of IMD",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "diabetes prevalence across 100,000 inhabitants")
plot_hypertension <- 
  ggplot2::ggplot(ons, aes(x = imd_10, y = hyper_ratio, fill = imd_10))+
  ggplot2::geom_bar(stat = "identity", position = position_dodge())+
  ggplot2::labs(title = "Prevalence of hypertension by decile of IMD",
                                  fill = "IMD",
                x = "decile of index of multiple deprivation",
                y = "hypertension prevalence across 100,000 inhabitants")


plot_diabetes
plot_hypertension
plot_obesity

````



Performing a binomial regression analysis
````{r, echo = FALSE}
data <- ons %>%
  dplyr::filter(week >=9 & week <=21) %>%
  dplyr::mutate(cfr_week = weekly_cfr_overall_adj/100,
                cfr_week_hospital = weekly_cfr_hospital_adj/100,
                cfr_week_home = weekly_cfr_home_adj/100,
                cfr_week_hospice = weekly_cfr_hospice_adj/100,
                cfr_week_carehome = weekly_cfr_carehome_adj/100,
                cfr_month = mcfr_overall_adj/100,
                cfr_month_hospital = mcfr_hospital_adj/100,
                cfr_month_home = mcfr_home_adj/100,
                cfr_month_hospice = mcfr_hospice_adj/100,
                cfr_month_careheom = mcfr_carehome_adj/100)
data$imd_10 <- factor(data$imd_10)
class(data$month)
colnames(data)

colnames(ons)

#---basic overall model with forced confounder such as gender and age
model_1 <- glm(cfr_week ~ week + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_1)
#--- nested model with ethnicity
model_1a <- glm(cfr_week ~ week + imd_10 + female_per + pop_over_65 + BAME_per, data = data,   family = "binomial")
summary(model_1a)
#---likelihood ratio test for the better model
anova(model_1, model_1a, test = "LRT")

model_hospital <- glm(cfr_week_hospital ~ week + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_hospital)

model_home <- glm(cfr_week_home ~ week + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_home)

model_hospice <- glm(cfr_week_hospice ~ week + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_hospice)

model_carehome <- glm(cfr_week_carehome ~ week + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_carehome)

#---monthly models
model_2 <- glm(cfr_month ~ month + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_2)

model_month_hospital <- glm(cfr_month_hospital ~ month + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_month_hospital)

model_month_home <- glm(cfr_month_home ~ month + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_month_home)

model_month_hospice <- glm(cfr_month_hospice ~ month + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_month_hospice)

model_month_carehome <- glm(cfr_month_careheom ~ month + imd_10 + female_per + pop_over_65, data = data,   family = "binomial")
summary(model_month_carehome)

test <- ons %>%
  select(code, name, imd_10) %>%
  distinct()

View(test)

````






